<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <span>üìä</span>
                <span>Abowdy</span>
            </div>
            <button class="sidebar-toggle" onclick="toggleSidebar()" title="Toggle sidebar">
                <span id="sidebar-toggle-icon">‚óÄ</span>
            </button>
        </div>
        
        <nav class="sidebar-nav">
            <div class="sidebar-nav-item">
                <a href="/" class="sidebar-nav-link" data-tooltip="Users">
                    <span class="nav-icon">üë•</span>
                    <span>Users</span>
                </a>
            </div>
            <div class="sidebar-nav-item">
                <a href="/apps" class="sidebar-nav-link" data-tooltip="Applications">
                    <span class="nav-icon">üì¶</span>
                    <span>Apps</span>
                </a>
            </div>
            <div class="sidebar-nav-item">
                <a href="/dashboard" class="sidebar-nav-link" data-tooltip="Activity">
                    <span class="nav-icon">üìä</span>
                    <span>Activity</span>
                </a>
            </div>
            <div class="sidebar-nav-item">
                <a href="/account" class="sidebar-nav-link" data-tooltip="Account">
                    <span class="nav-icon">‚öôÔ∏è</span>
                    <span>Account</span>
                </a>
            </div>
            <div class="sidebar-nav-item">
                <a href="/dev" class="sidebar-nav-link active" data-tooltip="Dev Tools">
                    <span class="nav-icon">üõ†Ô∏è</span>
                    <span>Dev</span>
                </a>
            </div>
        </nav>
        
        <div class="sidebar-footer">
            <div class="sidebar-footer-actions">
                <a href="/logout" class="sidebar-footer-link">
                    <span class="nav-icon">üö™</span>
                    <span>Logout</span>
                </a>
                <button class="sidebar-footer-link" onclick="toggleTheme()" style="border: none; background: transparent; width: 100%; text-align: left; cursor: pointer;" title="Toggle theme">
                    <span class="nav-icon" id="theme-icon">‚òÄÔ∏è</span>
                    <span>Theme</span>
                </button>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <header>
                <div class="header-content">
                    <h1>üõ†Ô∏è Dev Diagnostics</h1>
                    <p class="subtitle">Quick Graph API checks and raw payload previews</p>
                </div>
            </header>

            <% if (!graphConfigured) { %>
                <div class="alert-card alert-warning">
                    <h3>Graph API credentials not configured</h3>
                    <p>Set the Graph client ID and secret in your environment to enable diagnostics.</p>
                </div>
            <% } else if (!tenantConfigured) { %>
                <div class="alert-card alert-info">
                    <h3>No Microsoft 365 tenant connected</h3>
                    <p>Connect your Microsoft 365 (Entra ID) directory from the Account page to test Graph calls.</p>
                </div>
            <% } else { %>
                <section class="dev-diagnostics">
                    <div class="dev-tabs">
                        <button class="dev-tab active" data-tab="users" onclick="setDevTab('users')">Users</button>
                        <button class="dev-tab" data-tab="apps" onclick="setDevTab('apps')">Apps</button>
                        <button class="dev-tab" data-tab="activity" onclick="setDevTab('activity')">Activity</button>
                    </div>

                    <div class="dev-controls">
                        <div class="dev-input-group">
                            <label for="dev-limit">Limit</label>
                            <input id="dev-limit" type="number" min="1" max="50" value="10">
                        </div>
                        <div class="dev-input-group" id="dev-hours-group">
                            <label for="dev-hours">Lookback (hours)</label>
                            <input id="dev-hours" type="number" min="1" max="168" value="24">
                        </div>
                        <label class="dev-checkbox">
                            <input type="checkbox" id="dev-force-toggle">
                            <span>Force sync before fetch</span>
                        </label>
                        <button class="btn btn-primary" id="dev-fetch-btn" onclick="runDevFetch(event)">
                            üîÑ Fetch Selected Tab
                        </button>
                    </div>

                    <div class="dev-output">
                        <div class="dev-meta" id="dev-meta">
                            <p>Select a tab and click ‚ÄúFetch Selected Tab‚Äù to see raw API responses.</p>
                        </div>
                        <div class="dev-command" id="dev-command"></div>
                        <div class="dev-json" id="dev-json"></div>
                    </div>
                </section>
            <% } %>
        </div>
    </main>

    <script src="/js/ui-components.js"></script>
    <script>
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const icon = document.getElementById('sidebar-toggle-icon');
            sidebar.classList.toggle('collapsed');
            const isCollapsed = sidebar.classList.contains('collapsed');
            localStorage.setItem('sidebarCollapsed', isCollapsed);
            icon.textContent = isCollapsed ? '‚ñ∂' : '‚óÄ';
        }

        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            const icon = document.getElementById('theme-icon');
            if (icon) {
                icon.textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            const themeIcon = document.getElementById('theme-icon');
            if (themeIcon) {
                themeIcon.textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            }
            // Initialize sidebar state
            const sidebar = document.getElementById('sidebar');
            const sidebarIcon = document.getElementById('sidebar-toggle-icon');
            const savedSidebarState = localStorage.getItem('sidebarCollapsed') === 'true';
            if (savedSidebarState) {
                sidebar.classList.add('collapsed');
                sidebarIcon.textContent = '‚ñ∂';
            }

            // Default tab state
            setDevTab('users');
        });

        const devConfig = {
            users: {
                url: '/api/dev/graph/users',
                description: 'Fetches Microsoft 365 users via Graph.'
            },
            apps: {
                url: '/api/dev/graph/apps',
                description: 'Lists service principals (applications) available to the tenant.'
            },
            activity: {
                url: '/api/dev/graph/activity',
                description: 'Retrieves recent sign-in events from Entra audit logs.'
            }
        };

        let activeDevTab = 'users';

        function setDevTab(tab) {
            activeDevTab = tab;
            document.querySelectorAll('.dev-tab').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tab);
            });
            const hoursGroup = document.getElementById('dev-hours-group');
            if (hoursGroup) {
                hoursGroup.style.display = tab === 'activity' ? 'flex' : 'none';
            }
            const meta = document.getElementById('dev-meta');
            if (meta && devConfig[tab]) {
                meta.innerHTML = `<p><strong>${tab.toUpperCase()}:</strong> ${devConfig[tab].description}</p>`;
            }
        }

        async function runDevFetch(event) {
            const button = event?.target;
            if (!devConfig[activeDevTab]) {
                Toast.error('Unknown tab selected.');
                return;
            }

            const limitInput = document.getElementById('dev-limit');
            const hoursInput = document.getElementById('dev-hours');
            const forceToggle = document.getElementById('dev-force-toggle');
            const params = new URLSearchParams();

            const limit = Math.max(1, Math.min(50, parseInt(limitInput?.value || '10', 10)));
            params.set('limit', limit);

            if (activeDevTab === 'activity' && hoursInput) {
                const hours = Math.max(1, Math.min(168, parseInt(hoursInput.value || '24', 10)));
                params.set('hours', hours);
            }

            if (forceToggle?.checked) {
                params.set('force', 'true');
            }

            const commandBlock = document.getElementById('dev-command');
            const jsonBlock = document.getElementById('dev-json');
            const metaBlock = document.getElementById('dev-meta');

            const originalText = button ? button.innerHTML : null;
            if (button) {
                addButtonSpinner(button, button.innerHTML);
            }

            try {
                const response = await fetch(`${devConfig[activeDevTab].url}?${params.toString()}`);
                const payload = await response.json();

                if (!response.ok || payload.success === false) {
                    const errMsg = payload.error || `Request failed with status ${response.status}`;
                    Toast.error(errMsg);
                    if (metaBlock) {
                        metaBlock.innerHTML = `<p class="text-error">${escapeHtml(errMsg)}</p>`;
                    }
                    return;
                }

                if (commandBlock) {
                    commandBlock.innerHTML = `
                        <h3>Command</h3>
                        <pre>${escapeHtml(payload.command || 'N/A')}</pre>
                        <h4>Parameters</h4>
                        <pre>${escapeHtml(JSON.stringify(payload.params || {}, null, 2))}</pre>
                    `;
                }

                if (metaBlock) {
                    metaBlock.innerHTML = `
                        <p><strong>Requested:</strong> ${new Date(payload.requestedAt || Date.now()).toLocaleString()}</p>
                        <p><strong>Duration:</strong> ${payload.durationMs ?? 0} ms</p>
                        <p><strong>Items Returned:</strong> ${payload.meta?.totalReturned ?? (payload.data?.length || 0)}</p>
                    `;
                }

                if (jsonBlock) {
                    jsonBlock.innerHTML = `
                        <h3>Data</h3>
                        <pre>${escapeHtml(JSON.stringify(payload.data || [], null, 2))}</pre>
                        ${payload.meta ? `<h3>Metadata</h3><pre>${escapeHtml(JSON.stringify(payload.meta, null, 2))}</pre>` : ''}
                    `;
                }

                Toast.success('‚úì Graph data fetched successfully');
            } catch (error) {
                console.error('Dev fetch error:', error);
                Toast.error('Failed to fetch diagnostic data: ' + error.message);
                if (metaBlock) {
                    metaBlock.innerHTML = `<p class="text-error">${escapeHtml(error.message)}</p>`;
                }
            } finally {
                if (button && originalText) {
                    removeButtonSpinner(button);
                    button.innerHTML = originalText;
                }
            }
        }

        function escapeHtml(value) {
            if (value === null || value === undefined) {
                return '';
            }
            return value
                .toString()
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }
    </script>
</body>
</html>


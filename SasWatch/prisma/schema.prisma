// Prisma Schema for SasWatch - Multi-Tenant
// PostgreSQL database for Railway deployment

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Account model - represents organizations/tenants
model Account {
  id                    String    @id @default(uuid())
  name                  String // Organization name
  email                 String    @unique // Primary contact email (for billing/notifications)
  password              String? // Hashed password (DEPRECATED - use AccountMember.password)
  apiKey                String    @unique @default(uuid()) // Unique API key for this account
  isActive              Boolean   @default(true)
  isSuperAdmin          Boolean   @default(false) // DEPRECATED - use platformAdmin
  platformAdmin         Boolean   @default(false) // Platform-wide admin (for SaaS host)
  subscriptionTier      String    @default("free") // free, pro, enterprise
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  lastLoginAt           DateTime? // DEPRECATED - use AccountMember.lastLoginAt
  entraLastSyncAt       DateTime?
  entraTenantId         String? // Tenant ID from admin consent
  entraConnectedAt      DateTime? // When admin consent was granted
  entraSignInCursor     String?
  entraSignInLastSyncAt DateTime?
  hiddenLicenses        String[]  @default([]) // Licenses to hide from user display
  licenseCosts          Json?     @default("{}") // License pricing: { "licenseName": { costPerLicense, totalLicenses, totalCost } }

  // Inactivity Alert Settings
  inactivityAlertEnabled   Boolean   @default(false) // Enable automatic inactivity alerts
  inactivityAlertThreshold Int       @default(30)    // Days of inactivity before alert (30, 60, 90)
  inactivityAlertLastSent  DateTime?                 // Last time an inactivity alert was sent
  inactivityAlertEmail     String?                   // Override email for alerts (defaults to account email)

  // Notification Preferences (JSON object for flexible notification settings)
  notificationPreferences  Json?     @default("{}")

  // Email Verification (DEPRECATED - use AccountMember fields)
  emailVerified            Boolean   @default(false)
  emailVerificationToken   String?   @unique
  emailVerificationExpires DateTime?

  // Password Reset (DEPRECATED - use AccountMember fields)
  passwordResetToken   String?   @unique
  passwordResetExpires DateTime?

  // MFA/2FA (DEPRECATED - use AccountMember fields)
  mfaEnabled     Boolean  @default(true)
  mfaSecret      String? // TOTP secret (encrypted)
  mfaBackupCodes String[] @default([]) // Encrypted backup codes
  mfaMethod      String? // 'totp', 'sms', 'email' (for future)

  // Relations
  members              AccountMember[] // Team members who can log in
  users                User[]
  usageEvents          UsageEvent[]
  unmappedUsernames    UnmappedUsername[]
  scheduledReports     ScheduledReport[] // Automated report schedules
  auditLogs            AuditLog[]        // Admin action history
  appOverrides         AppOverride[]
  applications         Application[]
  entraSignIns         EntraSignIn[]
  subscriptions        Subscription[]
  pendingSubscriptions PendingSubscription[]
  partnerAccount       PartnerAccount?      @relation("PartnerAccountLink")
  partnerLinks         PartnerAccountLink[] @relation("PartnerLinkedAccount")
  headlessConnectors   HeadlessConnector[]


  @@index([email])
  @@index([apiKey])
  @@map("accounts")
}

// AuditLog model - tracks admin actions for compliance
model AuditLog {
  id          String   @id @default(uuid())
  accountId   String
  account     Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  actorId     String?  // Member who performed the action (null for system actions)
  action      String   // e.g., 'license.reclaim', 'user.update', 'settings.change'
  targetType  String   // e.g., 'user', 'license', 'account'
  targetId    String?  // ID of the affected entity
  details     Json?    // Additional context about the action
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  @@index([accountId])
  @@index([accountId, action])
  @@index([accountId, createdAt])
  @@map("audit_logs")
}

// ScheduledReport model - configurable automated email reports
model ScheduledReport {
  id          String   @id @default(uuid())
  accountId   String
  account     Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  name        String
  frequency   String   // 'weekly' or 'monthly'
  reportType  String   // 'usage-summary', 'license-utilization', 'inactive-users'
  dayOfWeek   String?  // For weekly: 'monday', 'tuesday', etc.
  dayOfMonth  Int?     // For monthly: 1-28
  recipients  String[] // Email addresses
  enabled     Boolean  @default(true)
  lastSentAt  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([accountId])
  @@index([accountId, enabled])
  @@map("scheduled_reports")
}

// AccountMember model - people who can log into an account (RBAC)
model AccountMember {
  id                       String    @id @default(uuid())
  accountId                String
  account                  Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  email                    String    @unique // Login email (globally unique)
  password                 String    // Hashed password
  name                     String    // Display name
  role                     String    @default("viewer") // owner, admin, editor, viewer
  isActive                 Boolean   @default(true)

  // Email Verification
  emailVerified            Boolean   @default(false)
  emailVerificationToken   String?   @unique
  emailVerificationExpires DateTime?

  // Password Reset
  passwordResetToken       String?   @unique
  passwordResetExpires     DateTime?

  // MFA/2FA - Email-based MFA using magic links
  mfaEnabled               Boolean   @default(true)
  mfaSecret                String?   // TOTP secret (for future)
  mfaBackupCodes           String[]  @default([])
  mfaMethod                String?   // 'email', 'totp', 'sms'

  // Tracking
  lastLoginAt              DateTime?
  invitedBy                String?   // ID of member who invited them
  invitationToken          String?   @unique // For pending invitations
  invitationExpires        DateTime?
  createdAt                DateTime  @default(now())
  updatedAt                DateTime  @updatedAt

  @@index([accountId])
  @@index([email])
  @@index([role])
  @@map("account_members")
}

// User model - stores Adobe users and their information
model User {
  id                  String    @id @default(uuid())
  accountId           String // Links to account (multi-tenant)
  account             Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  email               String
  firstName           String
  lastName            String
  adminRoles          String?
  userGroups          String?
  licenses            String[] // Array of license names
  lastActivity        DateTime?
  activityCount       Int       @default(0)
  importedAt          DateTime  @default(now())
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  entraId             String?
  entraAccountEnabled Boolean?
  entraLicenses       String[]  @default([])
  entraLastSyncedAt   DateTime?

  // Relations
  windowsUsernames WindowsUsername[]

  @@unique([accountId, email]) // Email unique per account
  @@index([accountId])
  @@index([email])
  @@index([lastActivity])
  @@map("users")
}

// Windows Username mapping - links Windows usernames to users
model WindowsUsername {
  id        String   @id @default(uuid())
  username  String   @unique // Windows usernames are globally unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@index([username])
  @@index([userId])
  @@map("windows_usernames")
}

// Unmapped usernames - Windows usernames that haven't been mapped to a user yet
model UnmappedUsername {
  id            String   @id @default(uuid())
  accountId     String // Links to account (multi-tenant)
  account       Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  username      String
  activityCount Int      @default(0)
  firstSeen     DateTime @default(now())
  lastSeen      DateTime @default(now())

  @@unique([accountId, username]) // Username unique per account
  @@index([accountId])
  @@index([username])
  @@map("unmapped_usernames")
}

// Usage events - tracks all activity (web, desktop, browser)
model UsageEvent {
  id         String   @id @default(uuid())
  accountId  String // Links to account (multi-tenant)
  account    Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  event      String // Event type (application_launch, web_browsing, etc.)
  url        String // URL or application/process name
  tabId      Int? // Browser tab ID (null for desktop apps)
  clientId   String // Client/device identifier
  why        String // Why the event was triggered (agent_monitor, adobe_reader_wrapper, etc.)
  when       DateTime // When the event occurred
  receivedAt DateTime @default(now()) // When we received the event

  // Desktop/Agent-specific fields (optional)
  windowsUser  String?
  userDomain   String?
  computerName String?
  windowTitle  String? // Window title for app launches
  browser      String? // Browser name for web_browsing events

  // Source tracking
  source String // 'adobe', 'wrapper', 'desktop', 'browser'

  createdAt DateTime @default(now())

  @@index([accountId])
  @@index([clientId])
  @@index([windowsUser])
  @@index([when])
  @@index([receivedAt])
  @@index([source])
  @@index([event])
  // Performance: Composite indexes for common query patterns
  @@index([accountId, source, receivedAt])
  @@index([accountId, receivedAt])
  @@map("usage_events")
}

// Application model - tracks software applications
model Application {
  id            String   @id @default(uuid())
  accountId     String // Links to account (multi-tenant)
  account       Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  vendor        String // e.g., "Adobe", "Microsoft"
  name          String // e.g., "Acrobat Pro", "Photoshop"
  detectedUsers Int      @default(0) // Number of users detected using this app
  licensesOwned Int      @default(0) // Total licenses purchased for this app
  isHidden      Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([accountId, vendor, name]) // Unique app per account
  @@index([accountId])
  @@index([vendor])
  @@map("applications")
}

// Application display overrides for auto-detected events
model AppOverride {
  id            String   @id @default(uuid())
  accountId     String
  account       Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  sourceKey     String
  vendor        String
  name          String
  licensesOwned Int      @default(0)
  isHidden      Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([accountId, sourceKey])
  @@index([accountId])
  @@map("app_overrides")
}

model EntraSignIn {
  id                      String   @id
  accountId               String
  account                 Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  createdDateTime         DateTime
  userDisplayName         String?
  userPrincipalName       String?
  userId                  String?
  appDisplayName          String?
  resourceDisplayName     String?
  clientAppUsed           String?
  deviceDisplayName       String?
  operatingSystem         String?
  browser                 String?
  ipAddress               String?
  locationCity            String?
  locationCountryOrRegion String?
  statusErrorCode         Int?
  statusFailureReason     String?
  riskState               String?
  riskDetail              String?
  conditionalAccessStatus String?
  correlationId           String?
  isInteractive           Boolean?
  sourceChannel           String?
  createdAt               DateTime @default(now())

  @@index([accountId, createdDateTime])
  @@index([accountId, userPrincipalName])
  @@map("entra_signins")
}

// Subscription model - tracks software subscriptions and renewal dates
model Subscription {
  id            String    @id @default(uuid())
  accountId     String
  account       Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)

  // Core fields
  name          String    // "Adobe Creative Cloud", "Microsoft 365 E3"
  vendor        String    // "Adobe", "Microsoft", "Salesforce"
  renewalDate   DateTime  // The key date for renewal
  cancelByDate  DateTime? // Optional: last day to cancel without penalty

  // Financial (USD only)
  cost          Decimal?  @db.Decimal(12, 2)
  billingCycle  String    @default("annual") // monthly, annual, multi-year

  // Details
  accountNumber String?   // Vendor account/contract number
  seats         Int?      // License count (optional)
  owner         String?   // Internal owner name
  notes         String?   // Free-form comments

  // Notifications
  alertEmail    String?   // Where to send reminder (defaults to account email if null)
  alertDays     Int[]     @default([60, 30, 7]) // Days before renewal to alert
  lastAlertSent DateTime? // Track when last alert was sent
  isArchived    Boolean   @default(false)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([accountId])
  @@index([accountId, renewalDate])
  @@index([renewalDate])
  @@map("subscriptions")
}

// PendingSubscription model - stores extracted subscription data awaiting user review
model PendingSubscription {
  id              String    @id @default(uuid())
  accountId       String
  account         Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)

  // Source tracking
  sourceType      String    // "email" or "upload"
  sourceEmailId   String?   // Graph API message ID (for deduplication)
  senderEmail     String?   // Original sender email

  // Extracted data (nullable - may be incomplete)
  vendor          String?
  name            String?   // Subscription name
  cost            Decimal?  @db.Decimal(12, 2)
  renewalDate     DateTime?
  billingCycle    String?   // monthly, annual, multi-year
  accountNumber   String?   // Vendor account/contract number

  // Metadata
  confidence      Float     @default(0) // 0-1 extraction confidence score
  rawText         String?   // Extracted text for debugging/reference
  attachmentNames String[]  @default([]) // Original filenames
  status          String    @default("pending") // pending, approved, rejected

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([accountId, sourceEmailId]) // Prevent duplicate email processing
  @@index([accountId])
  @@index([status])
  @@index([accountId, status])
  @@map("pending_subscriptions")
}

// Partner Account - links an Account to Partner API capabilities
model PartnerAccount {
  id                String               @id @default(uuid())
  accountId         String               @unique
  account           Account              @relation("PartnerAccountLink", fields: [accountId], references: [id], onDelete: Cascade)
  partnerApiKey     String               @unique @default(uuid())
  isActive          Boolean              @default(true)
  companyName       String?
  maxLinkedAccounts Int                  @default(100)
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  linkedAccounts    PartnerAccountLink[]

  @@index([partnerApiKey])
  @@map("partner_accounts")
}

// Links Partner to accounts they can access
model PartnerAccountLink {
  id               String         @id @default(uuid())
  partnerAccountId String
  partnerAccount   PartnerAccount @relation(fields: [partnerAccountId], references: [id], onDelete: Cascade)
  linkedAccountId  String
  linkedAccount    Account        @relation("PartnerLinkedAccount", fields: [linkedAccountId], references: [id], onDelete: Cascade)
  linkedAt         DateTime       @default(now())
  nickname         String?
  isActive         Boolean        @default(true)
  permissions      String[]       @default(["read"])

  @@unique([partnerAccountId, linkedAccountId])
  @@index([partnerAccountId])
  @@index([linkedAccountId])
  @@map("partner_account_links")
}

// HeadlessConnector model - for storing session data and credentials for headless automation
model HeadlessConnector {
  id             String    @id @default(uuid())
  accountId      String
  account        Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  vendor         String // "Adobe", "Zoom", etc.
  status         String    @default("pending") // active, error, expired, pending
  sessionData    String? // Encrypted JSON of Playwright storageState
  encryptedCreds String? // Optional: Encrypted username/password
  lastSyncAt     DateTime?
  errorMessage   String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@unique([accountId, vendor])
  @@index([accountId])
  @@map("headless_connectors")
}


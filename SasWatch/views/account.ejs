<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Settings - SasWatch</title>

    <!-- Performance: Preconnect to Font domains -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <meta name="description" content="Manage your SasWatch account, API keys, and integrations.">

    <!-- Performance: Preconnect to Font domains -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="/css/style.css">
    <!-- Icons as SVG for professional look -->
    <style>
        .svg-icon {
            width: 20px;
            height: 20px;
            fill: currentColor;
            display: inline-block;
            vertical-align: middle;
        }

        /* Modern Dashboard Layout */
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: minmax(0, 1fr) minmax(0, 1.4fr);
            gap: 24px;
            margin-top: 24px;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Premium Card Styling */
        .content-card {
            background: var(--bg-card);
            border: 1px solid var(--card-border);
            border-radius: 20px;
            padding: 24px;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            gap: 20px;
            height: fit-content;
        }

        .content-card:hover {
            box-shadow: var(--shadow-md);
            border-color: rgba(79, 209, 197, 0.3);
            transform: translateY(-2px);
        }

        .content-card h2 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-primary);
            padding-bottom: 0px;
        }

        .card-header-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: rgba(79, 209, 197, 0.1);
            color: var(--accent-primary);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .section-description {
            color: var(--text-secondary);
            font-size: 0.95rem;
            line-height: 1.5;
            margin-top: -10px;
        }

        /* Account Info Grid */
        .info-grid {
            display: grid;
            gap: 16px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding: 12px;
            background: var(--bg-primary);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .info-label {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-tertiary);
            font-weight: 600;
        }

        .info-value {
            font-size: 1.05rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        /* Status Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 99px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge-success {
            background: rgba(61, 170, 116, 0.15);
            color: #3DAA74;
            border: 1px solid rgba(61, 170, 116, 0.2);
        }

        .badge-warning {
            background: rgba(214, 138, 57, 0.15);
            color: #D68A39;
            border: 1px solid rgba(214, 138, 57, 0.2);
        }

        /* Integration Card */
        .integration-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-hover);
            padding: 16px;
            border-radius: 16px;
            border: 1px solid var(--border-color);
        }

        /* API Key Section */
        .api-key-container {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 14px;
            padding: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .api-key-input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.95rem;
            padding: 8px 12px;
            outline: none;
        }

        .action-btn {
            padding: 8px;
            border-radius: 8px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .action-btn:hover {
            background: rgba(79, 209, 197, 0.15);
            color: var(--accent-primary);
        }

        /* Form Styling */
        .modern-form-group {
            margin-bottom: 20px;
        }

        .modern-form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .modern-input,
        .modern-select {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 0.95rem;
            transition: all 0.2s;
        }

        .modern-input:focus,
        .modern-select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--accent-light);
        }

        /* Switches */
        .switch-group {
            display: grid;
            gap: 12px;
        }

        .switch-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.2s;
            border: 1px solid transparent;
        }

        .switch-item:hover {
            background: var(--bg-hover);
            border-color: var(--border-color);
        }

        .switch-item input[type="checkbox"] {
            margin-top: 4px;
            accent-color: var(--accent-primary);
            width: 18px;
            height: 18px;
        }
    </style>
</head>

<body>
    <%- include('partials/sidebar') %>

        <!-- Main Content -->
        <main class="main-content">
            <div class="account-container dashboard-container">
                <!-- Mobile Navigation -->
                <nav class="mobile-nav">
                    <!-- Mobile nav items maintained -->
                    <div class="mobile-nav-item">
                        <a href="/" class="mobile-nav-link">
                            <span class="nav-icon"><svg class="svg-icon" viewBox="0 0 24 24">
                                    <path
                                        d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2z" />
                                </svg></span>
                            <span>Renewals</span>
                        </a>
                    </div>
                    <div class="mobile-nav-item">
                        <a href="/users" class="mobile-nav-link">
                            <span class="nav-icon"><svg class="svg-icon" viewBox="0 0 24 24">
                                    <path
                                        d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5s-3 1.34-3 3 1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z" />
                                </svg></span>
                            <span>Users</span>
                        </a>
                    </div>
                    <!-- ... other items ... -->
                    <div class="mobile-nav-item">
                        <a href="/account" class="mobile-nav-link active">
                            <span class="nav-icon"><svg class="svg-icon" viewBox="0 0 24 24">
                                    <path
                                        d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z" />
                                </svg></span>
                            <span>Account</span>
                        </a>
                    </div>
                </nav>

                <div class="account-header">
                    <h1>
                        <span class="header-icon" aria-hidden="true">
                            <svg class="svg-icon" style="width: 28px; height: 28px;" viewBox="0 0 24 24">
                                <path
                                    d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z" />
                            </svg>
                        </span>
                        <span class="header-title-text">Account Settings</span>
                    </h1>
                </div>

                <div class="dashboard-grid">
                    <!-- Left Column -->
                    <div class="grid-column" style="display: flex; flex-direction: column; gap: 24px;">

                        <!-- Account Information Card -->
                        <div class="content-card">
                            <h2>
                                <div class="card-header-icon">
                                    <svg class="svg-icon" viewBox="0 0 24 24">
                                        <path
                                            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3 3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z" />
                                    </svg>
                                </div>
                                Organization Profile
                            </h2>

                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="info-label">Organization Name</span>
                                    <span class="info-value">
                                        <%= account.name %>
                                    </span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Account Email</span>
                                    <span class="info-value">
                                        <%= account.email %>
                                    </span>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div class="info-item">
                                        <span class="info-label">Member Since</span>
                                        <span class="info-value">
                                            <%= new Date(account.createdAt).toLocaleDateString() %>
                                        </span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Current Plan</span>
                                        <span class="info-value">
                                            <span class="badge badge-success" style="text-transform: capitalize;">
                                                <%= account.subscriptionTier %>
                                            </span>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Account Statistics Card -->
                        <div class="content-card">
                            <h2>
                                <div class="card-header-icon">
                                    <svg class="svg-icon" viewBox="0 0 24 24">
                                        <path
                                            d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z" />
                                    </svg>
                                </div>
                                Usage Statistics
                            </h2>

                            <div class="stats-grid" style="margin-bottom: 0;">
                                <div class="stat-card" style="padding: 1.5rem;">
                                    <div class="stat-number">
                                        <%= stats.users %>
                                    </div>
                                    <div class="stat-label">Adobe Users</div>
                                </div>
                                <div class="stat-card" style="padding: 1.5rem;">
                                    <div class="stat-number">
                                        <%= stats.usageEvents %>
                                    </div>
                                    <div class="stat-label">Usage Events</div>
                                </div>
                                <div class="stat-card" style="padding: 1.5rem;">
                                    <div class="stat-number">
                                        <%= stats.unmappedUsernames %>
                                    </div>
                                    <div class="stat-label">Unmapped Users</div>
                                </div>
                            </div>
                        </div>

                        <!-- Microsoft 365 Integration Card -->
                        <div class="content-card">
                            <h2>
                                <div class="card-header-icon">
                                    <svg class="svg-icon" viewBox="0 0 24 24">
                                        <path
                                            d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96z" />
                                    </svg>
                                </div>
                                Microsoft 365
                            </h2>
                            <p class="section-description">Connect your Entra ID directory to enable automatic user
                                syncing.
                            </p>

                            <% if (account.entraTenantId) { %>
                                <div class="integration-status">
                                    <div style="display: flex; gap: 12px; align-items: center;">
                                        <div
                                            style="background: var(--success); width: 10px; height: 10px; border-radius: 50%; box-shadow: 0 0 8px var(--success);">
                                        </div>
                                        <div>
                                            <div style="font-weight: 600; color: var(--text-primary);">Connected</div>
                                            <div style="font-size: 0.85rem; color: var(--text-secondary);">Last sync:
                                                <%= account.entraLastSyncAt ? new
                                                    Date(account.entraLastSyncAt).toLocaleString() : 'Never' %>
                                            </div>
                                        </div>
                                    </div>
                                    <button class="btn btn-outline" style="padding: 6px 16px; font-size: 0.85rem;"
                                        onclick="disconnectEntra()">
                                        Disconnect
                                    </button>
                                </div>
                                <% } else { %>
                                    <div class="integration-status"
                                        style="background: rgba(var(--warning-rgb), 0.05); border-color: var(--warning-light);">
                                        <div style="display: flex; gap: 12px; align-items: center;">
                                            <div
                                                style="background: var(--warning); width: 10px; height: 10px; border-radius: 50%;">
                                            </div>
                                            <div>
                                                <div style="font-weight: 600; color: var(--text-primary);">Not Connected
                                                </div>
                                                <div style="font-size: 0.85rem; color: var(--text-secondary);">Automatic
                                                    user syncing is disabled</div>
                                            </div>
                                        </div>
                                        <a href="/integrations/entra/connect" class="btn btn-primary"
                                            style="padding: 6px 16px; font-size: 0.85rem;">
                                            Connect
                                        </a>
                                    </div>
                                    <% } %>
                        </div>
                    </div>

                    <!-- Right Column -->
                    <div class="grid-column" style="display: flex; flex-direction: column; gap: 24px;">

                        <!-- API Key Card -->
                        <div class="content-card">
                            <h2>
                                <div class="card-header-icon">
                                    <svg class="svg-icon" viewBox="0 0 24 24">
                                        <path
                                            d="M7 11h2c.55 0 1 .45 1 1v5c0 .55-.45 1-1 1H7c-.55 0-1-.45-1-1v-5c0-.55.45-1 1-1zm4.03-3.03l1.42-1.42c-.43-.51-.9-.99-1.41-1.41l-1.42 1.42C7.86 5 5.81 5 3.77 5.77 2.12 7.12 1 9.29 1 11.5c0 2.21 1.12 4.38 2.77 5.73 2.04 1 4.09 1 6.13-.19.51-.43.99-.9 1.41-1.41l1.42 1.42c-.37.74-.82 1.43-1.38 2.07l1.42 1.42c.86-.94 1.54-2.02 1.99-3.19.14-.36.25-.74.34-1.13.09-.39.14-.79.14-1.19s-.05-.8-.14-1.19c-.09-.39-.2-.77-.34-1.13-.45-1.17-1.13-2.25-1.99-3.19l-1.42 1.42c.56.64 1.01 1.33 1.38 2.07zM21 7h-6v2h6V7zm-2 4h-4v2h4v-2zm-6 4h6v2h-6v-2z" />
                                    </svg>
                                </div>
                                API Access
                            </h2>
                            <p class="section-description">Your private key for PowerShell scripts and API access.</p>

                            <div class="api-key-container">
                                <input type="password" id="apiKeyInput" value="<%= account.apiKey %>"
                                    class="api-key-input" readonly>
                                <button class="action-btn" id="apiKeyToggle" type="button" title="Show API Key"
                                    onclick="toggleApiKeyVisibility(event)">
                                    <svg class="svg-icon" viewBox="0 0 24 24">
                                        <path
                                            d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z" />
                                    </svg>
                                </button>
                                <button class="action-btn" type="button" title="Copy Key" onclick="copyApiKey()">
                                    <svg class="svg-icon" viewBox="0 0 24 24">
                                        <path
                                            d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z" />
                                    </svg>
                                </button>
                                <button class="action-btn" type="button" title="Regenerate Key"
                                    onclick="regenerateApiKey(event)">
                                    <svg class="svg-icon" viewBox="0 0 24 24">
                                        <path
                                            d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm-6 8c0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3c-3.31 0-6-2.69-6-6z" />
                                    </svg>
                                </button>
                            </div>

                            <div class="badge badge-warning" style="align-self: flex-start;">
                                <span style="font-size: 1rem;">ðŸ”’</span> Keep this key secret!
                            </div>
                        </div>

                        <!-- Installer Card -->
                        <div class="content-card">
                            <h2>
                                <div class="card-header-icon">
                                    <svg class="svg-icon" viewBox="0 0 24 24">
                                        <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z" />
                                    </svg>
                                </div>
                                Activity Agent
                            </h2>
                            <p class="section-description">Customize and download the installer for your endpoints.</p>

                            <form id="agentInstallerForm" class="agent-config-form">
                                <div class="modern-form-group">
                                    <label>Monitoring Features</label>
                                    <div class="switch-group">
                                        <div class="switch-item">
                                            <input type="checkbox" name="enableApplicationMonitoring" checked>
                                            <div style="flex: 1;">
                                                <div style="font-weight: 600; font-size: 0.95rem;">Application
                                                    Monitoring
                                                </div>
                                                <div style="font-size: 0.85rem; color: var(--text-secondary);">Track app
                                                    launches</div>
                                            </div>
                                        </div>
                                        <div class="switch-item">
                                            <input type="checkbox" name="enableBrowserMonitoring" checked>
                                            <div style="flex: 1;">
                                                <div style="font-weight: 600; font-size: 0.95rem;">Browser Monitoring
                                                </div>
                                                <div style="font-size: 0.85rem; color: var(--text-secondary);">Track
                                                    URLs
                                                </div>
                                            </div>
                                        </div>
                                        <div class="switch-item">
                                            <input type="checkbox" name="enableWindowFocusMonitoring" checked>
                                            <div style="flex: 1;">
                                                <div style="font-weight: 600; font-size: 0.95rem;">Focus Monitoring
                                                </div>
                                                <div style="font-size: 0.85rem; color: var(--text-secondary);">Track
                                                    window
                                                    focus</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div class="modern-form-group">
                                        <label>Sync Interval</label>
                                        <select class="modern-select" name="checkIntervalSeconds">
                                            <option value="60" selected>1 minute</option>
                                            <option value="300">5 minutes</option>
                                            <option value="600">10 minutes</option>
                                        </select>
                                    </div>
                                    <div class="modern-form-group">
                                        <label>Startup</label>
                                        <select class="modern-select" name="startWithWindows">
                                            <option value="true" selected>Auto-start</option>
                                            <option value="false">Manual</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Hidden inputs for logic -->
                                <input type="hidden" name="apiUrl" placeholder="https://app.saswatch.com">

                                <button type="submit" class="btn btn-primary"
                                    style="width: 100%; justify-content: center; margin-top: 12px;">
                                    <svg class="svg-icon" viewBox="0 0 24 24">
                                        <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z" />
                                    </svg>
                                    Download Installer
                                </button>

                                <div
                                    style="margin-top: 16px; font-size: 0.85rem; color: var(--text-secondary); text-align: center;">
                                    Includes <code>Install-SasWatchAgent.ps1</code>
                                </div>
                            </form>
                        </div>

                    </div>
                </div>
            </div>



            <script src="/js/ui-components.js" defer></script>
            <script>


                async function copyApiKey() {
                    const input = document.getElementById('apiKeyInput');
                    await copyToClipboard(input.value, 'âœ“ API key copied to clipboard!');
                }

                function toggleApiKeyVisibility(event) {
                    const button = event.currentTarget;
                    const input = document.getElementById('apiKeyInput');
                    if (!input) return;

                    const shouldReveal = input.type === 'password';
                    input.type = shouldReveal ? 'text' : 'password';
                    button.innerHTML = shouldReveal ? '<svg class="svg-icon" viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z" /></svg>' : '<svg class="svg-icon" viewBox="0 0 24 24"><path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z" /></svg>';
                    button.title = shouldReveal ? 'Hide API Key' : 'Show API Key';
                }

                async function regenerateApiKey(event) {
                    const triggerButton = event?.currentTarget || event?.target || document.querySelector('.btn-regenerate');

                    const confirmed = await ConfirmModal.show({
                        title: 'Regenerate API Key?',
                        message: 'This will invalidate all existing scripts using the old key. You will need to re-download and re-deploy the monitoring script.',
                        confirmText: 'Regenerate Key',
                        cancelText: 'Cancel',
                        type: 'warning'
                    });

                    if (!confirmed) return;

                    if (triggerButton) {
                        addButtonSpinner(triggerButton, triggerButton.innerHTML);
                    }

                    try {
                        const response = await fetch('/api/account/regenerate-key', {
                            method: 'POST',
                            credentials: 'same-origin'
                        });

                        const result = await response.json();

                        if (result.success) {
                            document.getElementById('apiKeyInput').value = result.apiKey;
                            Toast.success('âœ“ API key regenerated successfully! Download the new monitoring script.');
                        } else {
                            Toast.error('Failed to regenerate API key: ' + result.error);
                        }
                    } catch (error) {
                        Toast.error('Error: ' + error.message);
                    } finally {
                        if (triggerButton) {
                            removeButtonSpinner(triggerButton);
                        }
                    }
                }

                async function disconnectEntra() {
                    const confirmed = await ConfirmModal.show({
                        title: 'Disconnect Microsoft 365?',
                        message: 'This will stop automatic user syncing from your Microsoft 365 directory. You can reconnect at any time.',
                        confirmText: 'Disconnect',
                        cancelText: 'Cancel',
                        type: 'warning'
                    });

                    if (!confirmed) return;

                    try {
                        const response = await fetch('/api/account/entra/disconnect', {
                            method: 'POST'
                        });

                        const result = await response.json();

                        if (result.success) {
                            Toast.success('Microsoft 365 disconnected successfully');
                            setTimeout(() => window.location.reload(), 1000);
                        } else {
                            Toast.error('Failed to disconnect: ' + result.error);
                        }
                    } catch (error) {
                        Toast.error('Error: ' + error.message);
                    }
                }

                // Expose to window for onclick handler
                window.disconnectEntra = disconnectEntra;

                // Handle success/error messages from query params
                document.addEventListener('DOMContentLoaded', () => {
                    const urlParams = new URLSearchParams(window.location.search);
                    const success = urlParams.get('success');
                    const error = urlParams.get('error');
                    const message = urlParams.get('message');

                    if (success === 'entra_connected') {
                        Toast.success('âœ“ Microsoft 365 connected successfully! User sync will begin automatically.');
                        // Clean URL
                        window.history.replaceState({}, document.title, window.location.pathname);
                    } else if (error) {
                        let errorMsg = 'Connection failed';
                        if (error === 'consent_denied') {
                            errorMsg = message || 'Admin consent was denied or cancelled';
                        } else if (error === 'invalid_state') {
                            errorMsg = 'Security validation failed. Please try again.';
                        } else if (error === 'no_tenant') {
                            errorMsg = 'No tenant information received. Please try again.';
                        } else if (error === 'callback_failed') {
                            errorMsg = 'Failed to process connection. Please try again.';
                        }
                        Toast.error('Microsoft 365 connection error: ' + errorMsg);
                        // Clean URL
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }
                });





                // Auto-fill API URL on page load
                document.addEventListener('DOMContentLoaded', () => {
                    const apiUrlInput = document.getElementById('apiUrl');
                    if (apiUrlInput && !apiUrlInput.value) {
                        // Get current origin
                        const currentOrigin = window.location.origin;
                        apiUrlInput.value = currentOrigin;
                    }
                });

                // Agent Installer Form Handler
                const agentInstallerForm = document.getElementById('agentInstallerForm');
                if (agentInstallerForm) {
                    agentInstallerForm.addEventListener('submit', async (e) => {
                        e.preventDefault();

                        const downloadBtn = document.getElementById('downloadInstallerBtn');
                        const originalText = downloadBtn.innerHTML;

                        // Disable button and show loading
                        downloadBtn.disabled = true;
                        downloadBtn.innerHTML = '<span class="spinner"></span> Generating installer...';

                        try {
                            // Collect form data
                            const formData = {
                                apiUrl: document.getElementById('apiUrl').value.trim(),
                                enableApplicationMonitoring: document.querySelector('input[name="enableApplicationMonitoring"]').checked,
                                enableWindowFocusMonitoring: document.querySelector('input[name="enableWindowFocusMonitoring"]').checked,
                                enableBrowserMonitoring: document.querySelector('input[name="enableBrowserMonitoring"]').checked,
                                enableNetworkMonitoring: document.querySelector('input[name="enableNetworkMonitoring"]').checked,
                                checkIntervalSeconds: parseInt(document.getElementById('checkIntervalSeconds').value) || 30,
                                startWithWindows: document.getElementById('startWithWindows').value === 'true',
                                hideGui: document.querySelector('input[name="hideGui"]').checked,
                                silentInstall: document.querySelector('input[name="silentInstall"]').checked
                            };

                            // Validate
                            if (!formData.apiUrl) {
                                Toast.error('Please enter an API URL');
                                downloadBtn.disabled = false;
                                downloadBtn.innerHTML = originalText;
                                return;
                            }

                            // Make POST request to generate installer
                            const response = await fetch('/download/activity-agent-installer', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(formData)
                            });

                            if (!response.ok) {
                                const error = await response.json().catch(() => ({ error: 'Failed to generate installer' }));
                                throw new Error(error.error || 'Failed to generate installer');
                            }

                            // Get filename from Content-Disposition header or use default
                            const contentDisposition = response.headers.get('Content-Disposition');
                            let filename = 'SasWatchAgent-Installer.zip';
                            if (contentDisposition) {
                                const match = contentDisposition.match(/filename="?(.+?)"?$/);
                                if (match) filename = match[1];
                            }

                            // Download the file
                            const blob = await response.blob();
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = filename;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            window.URL.revokeObjectURL(url);

                            Toast.success('âœ“ Installer downloaded successfully!');
                        } catch (error) {
                            console.error('Installer generation error:', error);
                            Toast.error('Failed to generate installer: ' + error.message);
                        } finally {
                            downloadBtn.disabled = false;
                            downloadBtn.innerHTML = originalText;
                        }
                    });
                }
            </script>
            </div>
        </main>
        <%- include('_survey-widget') %>
</body>

</html>
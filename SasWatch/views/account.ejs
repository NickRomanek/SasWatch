<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Settings - SasWatch</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .account-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .account-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 2px solid var(--border-color);
        }

        .account-header h1 {
            margin: 0;
            color: var(--text-primary);
            font-size: 2rem;
            font-weight: 700;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .btn-back {
            padding: 10px 20px;
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-back:hover {
            background: var(--bg-hover);
            border-color: var(--border-hover);
        }

        .btn-logout {
            padding: 10px 20px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-logout:hover {
            background: #dc2626;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .account-section {
            background: var(--bg-card);
            padding: 32px;
            margin-bottom: 24px;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            transition: all 0.2s;
        }

        .account-section:hover {
            box-shadow: var(--shadow-md);
        }

        .account-section h2 {
            margin-top: 0;
            margin-bottom: 24px;
            color: var(--text-primary);
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-description {
            color: var(--text-secondary);
            margin-bottom: 24px;
            line-height: 1.6;
        }

        .info-row {
            display: flex;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .info-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .info-label {
            width: 180px;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .info-value {
            flex: 1;
            color: var(--text-primary);
            font-weight: 500;
        }

        .subscription-badge {
            background: var(--success);
            color: white;
            padding: 6px 14px;
            border-radius: 16px;
            font-size: 0.75rem;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .entra-status-connected,
        .entra-status-disconnected {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 16px;
        }

        .status-header {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .status-icon {
            font-size: 1.5rem;
        }

        .status-meta {
            margin: 4px 0 0 0;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .status-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn-connect {
            padding: 10px 20px;
            background: var(--accent-primary);
            color: white;
            border: none;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-connect:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-disconnect {
            padding: 10px 20px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-disconnect:hover {
            background: #dc2626;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }


        .info-box {
            display: flex;
            gap: 12px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .info-icon {
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .api-key-display {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .api-key-input-wrapper {
            position: relative;
            flex: 1;
            min-width: 280px;
        }

        .api-key-input-wrapper input {
            width: 100%;
            padding: 12px 48px 12px 16px;
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            font-size: 0.875rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-eye-toggle {
            position: absolute;
            top: 50%;
            right: 8px;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            padding: 4px 8px;
            color: var(--text-secondary);
            transition: color 0.2s ease;
        }

        .btn-eye-toggle:hover {
            color: var(--text-primary);
        }

        .btn-copy {
            padding: 10px 20px;
            background: var(--accent-primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-copy:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-regenerate {
            padding: 10px 20px;
            background: var(--warning);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-regenerate:hover {
            background: #d97706;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-download {
            padding: 12px 24px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.938rem;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-download:hover {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .warning-box {
            background: var(--warning-light);
            border: 1px solid var(--warning);
            padding: 16px 20px;
            border-radius: 8px;
            margin-top: 20px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        [data-theme="dark"] .warning-box {
            background: rgba(245, 158, 11, 0.1);
        }

        .warning-box strong {
            color: var(--warning);
        }

        .warning-icon {
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .download-grid {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 24px;
        }

        .download-card {
            border: 1px solid var(--border-color);
            padding: 24px;
            border-radius: 12px;
            background: var(--bg-secondary);
            transition: all 0.2s;
        }

        .download-card:hover {
            border-color: var(--accent-primary);
            box-shadow: var(--shadow-md);
        }

        .download-card h3 {
            margin: 0 0 12px 0;
            color: var(--text-primary);
            font-size: 1.125rem;
            font-weight: 600;
        }

        .download-card p {
            color: var(--text-secondary);
            margin-bottom: 16px;
            line-height: 1.5;
        }

        .download-card ul {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 20px;
            padding-left: 20px;
            line-height: 1.8;
        }

        .deployment-note {
            margin-top: 24px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 8px;
            border-left: 4px solid var(--accent-primary);
            color: var(--text-secondary);
            font-size: 0.875rem;
            line-height: 1.6;
        }

        .deployment-note strong {
            color: var(--text-primary);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-top: 24px;
        }

        .stat-card {
            background: var(--bg-secondary);
            padding: 24px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid var(--border-color);
            transition: all 0.2s;
        }

        .stat-card:hover {
            border-color: var(--accent-primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 8px;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .agent-config-form {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.938rem;
        }

        .form-group input[type="text"],
        .form-group select {
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 0.938rem;
            transition: all 0.2s;
        }

        .form-group input[type="text"]:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-group small {
            color: var(--text-secondary);
            font-size: 0.813rem;
            margin-top: -4px;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-top: 8px;
        }

        .checkbox-label {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .checkbox-label:hover {
            border-color: var(--accent-primary);
            background: var(--bg-hover);
        }

        .checkbox-label input[type="checkbox"] {
            margin-top: 2px;
            cursor: pointer;
            width: 18px;
            height: 18px;
            accent-color: var(--accent-primary);
        }

        .checkbox-label span {
            flex: 1;
            font-weight: 500;
            color: var(--text-primary);
        }

        .checkbox-label small {
            display: block;
            color: var(--text-secondary);
            font-size: 0.813rem;
            margin-top: 4px;
        }

        .form-actions {
            margin-top: 8px;
        }

        .form-actions .btn-download {
            width: 100%;
            justify-content: center;
        }

        .survey-tab-button {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--accent-primary);
            color: #fff;
            border: none;
            padding: 14px 24px;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(15, 23, 42, 0.3);
            cursor: pointer;
            font-weight: 600;
            letter-spacing: 0.02em;
            font-size: 1rem;
            z-index: 1200;
            transition: all 0.2s ease;
        }

        .survey-tab-button:hover {
            background: var(--accent-hover);
            box-shadow: 0 25px 50px rgba(15, 23, 42, 0.35);
            transform: translateY(-2px);
        }

        .survey-modal {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.75);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1300;
            padding: 24px;
        }

        .survey-modal.open {
            display: flex;
        }

        .survey-modal-content {
            background: var(--bg-card);
            border-radius: 16px;
            width: min(520px, 95vw);
            padding: 32px;
            border: 1px solid var(--border-color);
            box-shadow: 0 25px 55px rgba(15, 23, 42, 0.35);
            animation: slideUp 0.25s ease;
        }

        .survey-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 16px;
            margin-bottom: 20px;
        }

        .survey-modal-header h3 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--text-primary);
        }

        .survey-modal-header p {
            margin: 4px 0 0 0;
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .survey-modal-close {
            border: none;
            background: transparent;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .survey-modal-close:hover {
            color: var(--text-primary);
        }

        .survey-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .survey-form label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text-primary);
        }

        .survey-form input,
        .survey-form textarea,
        .survey-form select {
            width: 100%;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 12px 14px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .survey-form textarea {
            min-height: 120px;
            resize: vertical;
        }

        .survey-submit-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            background: var(--accent-primary);
            color: white;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s ease;
        }

        .survey-submit-btn:hover:not(:disabled) {
            background: var(--accent-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .survey-submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        @media (max-width: 768px) {
            .account-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }

            .api-key-display {
                flex-direction: column;
            }

            .api-key-display input {
                width: 100%;
            }

            .download-grid {
                grid-template-columns: 1fr;
            }

            .survey-tab-button {
                bottom: 16px;
                right: 16px;
                padding: 12px 20px;
                font-size: 0.95rem;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <img src="/images/logoTransp.png" alt="SasWatch" class="logo-image" width="32" height="32">
                <span>SasWatch</span>
            </div>
            <button class="sidebar-toggle" onclick="toggleSidebar()" title="Toggle sidebar">
                <span id="sidebar-toggle-icon">‚óÄ</span>
            </button>
        </div>
        
        <nav class="sidebar-nav">
            <div class="sidebar-nav-item">
                <a href="/" class="sidebar-nav-link" data-tooltip="Renewals">
                    <span class="nav-icon">üìÖ</span>
                    <span>Renewals</span>
                </a>
            </div>
            <div class="sidebar-nav-item">
                <a href="/users" class="sidebar-nav-link" data-tooltip="Users">
                    <span class="nav-icon">üë•</span>
                    <span>Users</span>
                </a>
            </div>
            <div class="sidebar-nav-item">
                <a href="/licenses" class="sidebar-nav-link" data-tooltip="Licenses">
                    <span class="nav-icon">üìú</span>
                    <span>Licenses</span>
                </a>
            </div>
            <div class="sidebar-nav-item">
                <a href="/apps" class="sidebar-nav-link" data-tooltip="Applications">
                    <span class="nav-icon">üì¶</span>
                    <span>Apps</span>
                </a>
            </div>
            <div class="sidebar-nav-item">
                <a href="/dashboard" class="sidebar-nav-link" data-tooltip="Activity">
                    <span class="nav-icon">üìä</span>
                    <span>Activity</span>
                </a>
            </div>
            <div class="sidebar-nav-item">
                <a href="/members" class="sidebar-nav-link" data-tooltip="Team">
                    <span class="nav-icon">üßë‚Äçü§ù‚Äçüßë</span>
                    <span>Team</span>
                </a>
            </div>
            <div class="sidebar-nav-item">
                <a href="/account" class="sidebar-nav-link active" data-tooltip="Account">
                    <span class="nav-icon">‚öôÔ∏è</span>
                    <span>Account</span>
                </a>
            </div>
            <% if (typeof account !== 'undefined' && account && (account.isSuperAdmin || account.platformAdmin)) { %>
            <div class="sidebar-nav-item">
                <a href="/dev" class="sidebar-nav-link" data-tooltip="Dev Tools">
                    <span class="nav-icon">üõ†Ô∏è</span>
                    <span>Dev</span>
                </a>
            </div>
            <% } %>
            <% if (typeof account !== 'undefined' && account && (account.isSuperAdmin || account.platformAdmin)) { %>
            <div class="sidebar-nav-item">
                <a href="/admin" class="sidebar-nav-link" data-tooltip="Platform Admin">
                    <span class="nav-icon">üëë</span>
                    <span>Platform Admin</span>
                </a>
            </div>
            <% } %>
        </nav>
        
        <div class="sidebar-footer">
            <div class="sidebar-footer-actions">
                <a href="/logout" class="sidebar-footer-link">
                    <span class="nav-icon">üö™</span>
                    <span>Logout</span>
                </a>
                <button class="sidebar-footer-link" onclick="toggleTheme()" style="border: none; background: transparent; width: 100%; text-align: left; cursor: pointer;" title="Toggle theme">
                    <span class="nav-icon" id="theme-icon">‚òÄÔ∏è</span>
                    <span>Theme</span>
                </button>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="account-container">
            <!-- Mobile Navigation -->
            <nav class="mobile-nav">
                <div class="mobile-nav-item">
                    <a href="/" class="mobile-nav-link">
                        <span>üìÖ</span>
                        <span>Renewals</span>
                    </a>
                </div>
                <div class="mobile-nav-item">
                    <a href="/users" class="mobile-nav-link">
                        <span>üë•</span>
                        <span>Users</span>
                    </a>
                </div>
                <div class="mobile-nav-item">
                    <a href="/licenses" class="mobile-nav-link">
                        <span>üìú</span>
                        <span>Licenses</span>
                    </a>
                </div>
                <div class="mobile-nav-item">
                    <a href="/apps" class="mobile-nav-link">
                        <span>üì¶</span>
                        <span>Apps</span>
                    </a>
                </div>
                <div class="mobile-nav-item">
                    <a href="/dashboard" class="mobile-nav-link">
                        <span>üìä</span>
                        <span>Activity</span>
                    </a>
                </div>
                <div class="mobile-nav-item">
                    <a href="/account" class="mobile-nav-link active">
                        <span>‚öôÔ∏è</span>
                        <span>Account</span>
                    </a>
                </div>
                <% if (typeof account !== 'undefined' && account && account.isSuperAdmin) { %>
                <div class="mobile-nav-item">
                    <a href="/dev" class="mobile-nav-link">
                        <span>üõ†Ô∏è</span>
                        <span>Dev</span>
                    </a>
                </div>
                <% } %>
            </nav>

            <div class="account-header">
                <h1>
                    <span class="header-icon" aria-hidden="true">‚öôÔ∏è</span>
                    <span class="header-title-text">Account Settings</span>
                </h1>
            </div>

        <!-- Account Information -->
        <div class="account-section">
            <h2>üë§ Account Information</h2>
            <div class="info-row">
                <div class="info-label">Organization:</div>
                <div class="info-value"><%= account.name %></div>
            </div>
            <div class="info-row">
                <div class="info-label">Email:</div>
                <div class="info-value"><%= account.email %></div>
            </div>
            <div class="info-row">
                <div class="info-label">Account Created:</div>
                <div class="info-value"><%= new Date(account.createdAt).toLocaleDateString() %></div>
            </div>
            <div class="info-row">
                <div class="info-label">Subscription:</div>
                <div class="info-value">
                    <span class="subscription-badge">
                        <%= account.subscriptionTier %>
                    </span>
                </div>
            </div>
        </div>

        <!-- Microsoft 365 Integration -->
        <div class="account-section">
            <h2>‚òÅÔ∏è Microsoft 365 Integration</h2>
            <p class="section-description">Connect your Microsoft 365 (Entra ID) directory to automatically sync user data, licenses, and account status.</p>
            
            <% if (account.entraTenantId) { %>
                <div class="entra-status-connected">
                    <div class="status-header">
                        <span class="status-icon">‚úÖ</span>
                        <div>
                            <strong>Connected</strong>
                            <p class="status-meta">
                                Connected on <%= account.entraConnectedAt ? new Date(account.entraConnectedAt).toLocaleString() : 'recently' %>
                                <% if (account.entraLastSyncAt) { %>
                                    <br>Last sync: <%= new Date(account.entraLastSyncAt).toLocaleString() %>
                                <% } %>
                            </p>
                        </div>
                    </div>
                    <div class="status-actions">
                        <button class="btn-disconnect" onclick="disconnectEntra()">üîå Disconnect</button>
                    </div>
                </div>
            <% } else { %>
                <div class="entra-status-disconnected">
                    <div class="status-header">
                        <span class="status-icon">‚ö†Ô∏è</span>
                        <div>
                            <strong>Not Connected</strong>
                            <p class="status-meta">Connect to automatically sync user data from your Microsoft 365 directory.</p>
                        </div>
                    </div>
                    <a href="/integrations/entra/connect" class="btn-connect">üîó Connect Microsoft 365</a>
                </div>
            <% } %>
        </div>

        <!-- API Key -->
        <div class="account-section">
            <h2>üîë API Key</h2>
            <p class="section-description">Use this API key in your PowerShell monitoring scripts to send data to your account.</p>
            
            <div class="api-key-display">
                <div class="api-key-input-wrapper">
                    <input type="password" id="apiKeyInput" value="<%= account.apiKey %>" readonly>
                    <button class="btn-eye-toggle" id="apiKeyToggle" type="button" title="Show API Key" onclick="toggleApiKeyVisibility(event)">üëÅÔ∏è</button>
                </div>
                <button class="btn-copy" onclick="copyApiKey()">üìã Copy</button>
                <button class="btn-regenerate" onclick="regenerateApiKey(event)">üîÑ Regenerate</button>
            </div>
            
            <div class="warning-box">
                <span class="warning-icon">‚ö†Ô∏è</span>
                <div>
                    <strong>Keep this key secret!</strong> Anyone with this key can send data to your SasWatch account. If you regenerate this key, update and redeploy your PowerShell monitoring script and any Intune packages so they use the new value.
                </div>
            </div>
        </div>

        <!-- Activity Agent Installer -->
        <div class="account-section">
            <h2>üì• Activity Agent Installer</h2>
            <p class="section-description">Configure and download a custom installer for the SasWatch Activity Agent. The installer will download the latest agent from GitHub and configure it with your settings.</p>

            <form id="agentInstallerForm" class="agent-config-form">
                <!-- API Configuration -->
                <div class="form-group">
                    <label for="apiUrl">API URL</label>
                    <input type="text" id="apiUrl" name="apiUrl" value="" placeholder="https://app.saswatch.com">
                    <small>Base URL for your SasWatch instance (will be auto-filled on page load)</small>
                </div>

                <div class="form-group">
                    <label for="apiKeyDisplay">API Key</label>
                    <div class="api-key-display">
                        <div class="api-key-input-wrapper">
                            <input type="password" id="apiKeyDisplay" value="<%= account.apiKey %>" readonly>
                            <button class="btn-eye-toggle" type="button" onclick="toggleApiKeyVisibility(event)">üëÅÔ∏è</button>
                        </div>
                        <button class="btn-copy" type="button" onclick="copyApiKey()">üìã Copy</button>
                    </div>
                    <small>Your API key (auto-filled from account)</small>
                </div>

                <!-- Monitoring Options -->
                <div class="form-group">
                    <label>Monitoring Options</label>
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="enableApplicationMonitoring" checked>
                            <span>Application Monitoring</span>
                            <small>Track application launches</small>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="enableWindowFocusMonitoring" checked>
                            <span>Window Focus Monitoring</span>
                            <small>Track window focus changes</small>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="enableBrowserMonitoring" checked>
                            <span>Browser URL Monitoring</span>
                            <small>Track browser URLs and domains</small>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="enableNetworkMonitoring">
                            <span>Network Monitoring</span>
                            <small>Track network connections (high volume)</small>
                        </label>
                    </div>
                </div>

                <!-- Check Interval -->
                <div class="form-group">
                    <label for="checkIntervalSeconds">Check Interval</label>
                    <select id="checkIntervalSeconds" name="checkIntervalSeconds">
                        <option value="30">30 seconds</option>
                        <option value="60" selected>1 minute</option>
                        <option value="300">5 minutes</option>
                        <option value="600">10 minutes</option>
                    </select>
                    <small>How often the agent sends data to the server</small>
                </div>

                <!-- Startup Behavior -->
                <div class="form-group">
                    <label for="startWithWindows">Startup Behavior</label>
                    <select id="startWithWindows" name="startWithWindows">
                        <option value="true" selected>Start with Windows</option>
                        <option value="false">Manual start only</option>
                    </select>
                    <small>Whether to start the agent automatically on Windows startup</small>
                </div>

                <!-- Install Options -->
                <div class="form-group">
                    <label>Install Options</label>
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="hideGui">
                            <span>Hide GUI / Tray-only mode</span>
                            <small>Run in system tray only (no main window)</small>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="silentInstall">
                            <span>Silent Install</span>
                            <small>For Intune/SCCM deployment (no user prompts)</small>
                        </label>
                    </div>
                </div>

                <!-- Download Button -->
                <div class="form-actions">
                    <button type="submit" class="btn-download" id="downloadInstallerBtn">
                        üì• Download Installer Package
                    </button>
                </div>

                <div class="deployment-note">
                    <strong>üì¶ Installation:</strong> Extract the ZIP file and run <code>Install-SasWatchAgent.ps1</code> as Administrator. 
                    For silent installation (Intune/SCCM), use: <code>powershell.exe -ExecutionPolicy Bypass -File "Install-SasWatchAgent.ps1" -Silent</code>
                </div>
            </form>
        </div>

        <!-- Account Stats -->
        <div class="account-section">
            <h2>üìä Account Statistics</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number"><%= stats.users %></div>
                    <div class="stat-label">Adobe Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number"><%= stats.usageEvents %></div>
                    <div class="stat-label">Usage Events</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number"><%= stats.unmappedUsernames %></div>
                    <div class="stat-label">Unmapped Users</div>
                </div>
            </div>
        </div>
    </div>

    <button class="survey-tab-button" id="surveyTabButton" type="button" aria-controls="surveyModal" aria-haspopup="dialog">
        Feedback
    </button>

    <div class="survey-modal" id="surveyModal" aria-hidden="true">
        <div class="survey-modal-content" role="dialog" aria-modal="true" aria-labelledby="surveyModalTitle">
            <div class="survey-modal-header">
                <div>
                    <h3 id="surveyModalTitle">Share Your Feedback</h3>
                    <p>Tell us how SasWatch is working for your team.</p>
                </div>
                <button class="survey-modal-close" id="surveyModalClose" type="button" aria-label="Close survey form">√ó</button>
            </div>

            <form class="survey-form" id="surveyForm">
                <div>
                    <label for="surveyEmail">Work Email <span style="color: var(--accent-primary);">*</span></label>
                    <input type="email" id="surveyEmail" name="email" placeholder="you@company.com" required>
                </div>

                <div>
                    <label for="surveyRating">Overall experience</label>
                    <select id="surveyRating" name="rating">
                        <option value="">Choose an option</option>
                        <option value="Amazing">Amazing</option>
                        <option value="Good">Good</option>
                        <option value="Okay">Okay</option>
                        <option value="Needs improvement">Needs improvement</option>
                    </select>
                </div>

                <div>
                    <label for="surveyFeedback">Feedback or feature requests</label>
                    <textarea id="surveyFeedback" name="feedback" placeholder="Share any thoughts you'd like us to know"></textarea>
                </div>

                <button type="submit" class="survey-submit-btn" id="surveySubmitButton">
                    <span>Send Feedback</span>
                </button>
            </form>
        </div>
    </div>

    <script src="/js/ui-components.js"></script>
    <script>
        const SURVEY_EMAIL_REGEX = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

        async function copyApiKey() {
            const input = document.getElementById('apiKeyInput');
            await copyToClipboard(input.value, '‚úì API key copied to clipboard!');
        }

        function toggleApiKeyVisibility(event) {
            const button = event.currentTarget;
            const input = document.getElementById('apiKeyInput');
            if (!input) return;

            const shouldReveal = input.type === 'password';
            input.type = shouldReveal ? 'text' : 'password';
            button.textContent = shouldReveal ? 'üôà' : 'üëÅÔ∏è';
            button.title = shouldReveal ? 'Hide API Key' : 'Show API Key';
        }

        async function regenerateApiKey(event) {
            const triggerButton = event?.currentTarget || event?.target || document.querySelector('.btn-regenerate');

            const confirmed = await ConfirmModal.show({
                title: 'Regenerate API Key?',
                message: 'This will invalidate all existing scripts using the old key. You will need to re-download and re-deploy the monitoring script.',
                confirmText: 'Regenerate Key',
                cancelText: 'Cancel',
                type: 'warning'
            });

            if (!confirmed) return;

            if (triggerButton) {
                addButtonSpinner(triggerButton, triggerButton.innerHTML);
            }

            try {
                const response = await fetch('/api/account/regenerate-key', {
                    method: 'POST',
                    credentials: 'same-origin'
                });

                const result = await response.json();

                if (result.success) {
                    document.getElementById('apiKeyInput').value = result.apiKey;
                    Toast.success('‚úì API key regenerated successfully! Download the new monitoring script.');
                } else {
                    Toast.error('Failed to regenerate API key: ' + result.error);
                }
            } catch (error) {
                Toast.error('Error: ' + error.message);
            } finally {
                if (triggerButton) {
                    removeButtonSpinner(triggerButton);
                }
            }
        }

        async function disconnectEntra() {
            const confirmed = await ConfirmModal.show({
                title: 'Disconnect Microsoft 365?',
                message: 'This will stop automatic user syncing from your Microsoft 365 directory. You can reconnect at any time.',
                confirmText: 'Disconnect',
                cancelText: 'Cancel',
                type: 'warning'
            });

            if (!confirmed) return;

            try {
                const response = await fetch('/api/account/entra/disconnect', {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    Toast.success('Microsoft 365 disconnected successfully');
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    Toast.error('Failed to disconnect: ' + result.error);
                }
            } catch (error) {
                Toast.error('Error: ' + error.message);
            }
        }

        // Expose to window for onclick handler
        window.disconnectEntra = disconnectEntra;

        // Handle success/error messages from query params
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const success = urlParams.get('success');
            const error = urlParams.get('error');
            const message = urlParams.get('message');

            if (success === 'entra_connected') {
                Toast.success('‚úì Microsoft 365 connected successfully! User sync will begin automatically.');
                // Clean URL
                window.history.replaceState({}, document.title, window.location.pathname);
            } else if (error) {
                let errorMsg = 'Connection failed';
                if (error === 'consent_denied') {
                    errorMsg = message || 'Admin consent was denied or cancelled';
                } else if (error === 'invalid_state') {
                    errorMsg = 'Security validation failed. Please try again.';
                } else if (error === 'no_tenant') {
                    errorMsg = 'No tenant information received. Please try again.';
                } else if (error === 'callback_failed') {
                    errorMsg = 'Failed to process connection. Please try again.';
                }
                Toast.error('Microsoft 365 connection error: ' + errorMsg);
                // Clean URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        });

        // Theme toggle functionality
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);

            // Update icon
            const icon = document.getElementById('theme-icon');
            icon.textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }

        // Sidebar toggle functionality
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const icon = document.getElementById('sidebar-toggle-icon');
            sidebar.classList.toggle('collapsed');
            
            // Save state
            const isCollapsed = sidebar.classList.contains('collapsed');
            localStorage.setItem('sidebarCollapsed', isCollapsed);
            icon.textContent = isCollapsed ? '‚ñ∂' : '‚óÄ';
        }

        // Expose to window for onclick handlers
        window.toggleTheme = toggleTheme;
        window.toggleSidebar = toggleSidebar;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize theme (default to dark)
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            const themeIcon = document.getElementById('theme-icon');
            themeIcon.textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            
            // Initialize sidebar state
            const sidebar = document.getElementById('sidebar');
            const sidebarIcon = document.getElementById('sidebar-toggle-icon');
            const savedSidebarState = localStorage.getItem('sidebarCollapsed') === 'true';
            if (savedSidebarState) {
                sidebar.classList.add('collapsed');
                sidebarIcon.textContent = '‚ñ∂';
            }
        });

        function initSurveyModal() {
            const modal = document.getElementById('surveyModal');
            const tabButton = document.getElementById('surveyTabButton');
            const closeButton = document.getElementById('surveyModalClose');
            const form = document.getElementById('surveyForm');
            const submitButton = document.getElementById('surveySubmitButton');

            if (!modal || !tabButton || !closeButton || !form || !submitButton) {
                return;
            }

            const openModal = () => {
                modal.classList.add('open');
                modal.setAttribute('aria-hidden', 'false');
                const firstField = form.querySelector('input, textarea, select');
                if (firstField) {
                    firstField.focus();
                }
            };

            const closeModal = () => {
                modal.classList.remove('open');
                modal.setAttribute('aria-hidden', 'true');
            };

            tabButton.addEventListener('click', openModal);
            closeButton.addEventListener('click', closeModal);
            modal.addEventListener('click', (event) => {
                if (event.target === modal) {
                    closeModal();
                }
            });

            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && modal.classList.contains('open')) {
                    closeModal();
                }
            });

            form.addEventListener('submit', async (event) => {
                event.preventDefault();
                if (submitButton.disabled) return;

                const email = form.email.value.trim();
                const feedback = form.feedback.value.trim();
                const rating = form.rating.value.trim();

                if (!SURVEY_EMAIL_REGEX.test(email)) {
                    Toast.error('Please enter a valid email address.');
                    form.email.focus();
                    return;
                }

                submitButton.disabled = true;
                const previousContent = submitButton.innerHTML;
                submitButton.innerHTML = '<span class="spinner"></span> Sending...';

                try {
                    const response = await fetch('/api/survey/submit', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ email, feedback, rating })
                    });

                    const result = await response.json();

                    if (!response.ok || !result.success) {
                        throw new Error(result.message || 'Unable to send feedback right now.');
                    }

                    Toast.success('Thanks for sharing your feedback!');
                    form.reset();
                    closeModal();
                } catch (error) {
                    Toast.error(error.message || 'Unable to send feedback right now.');
                } finally {
                    submitButton.disabled = false;
                    submitButton.innerHTML = previousContent;
                }
            });
        }

        document.addEventListener('DOMContentLoaded', initSurveyModal);

        // Auto-fill API URL on page load
        document.addEventListener('DOMContentLoaded', () => {
            const apiUrlInput = document.getElementById('apiUrl');
            if (apiUrlInput && !apiUrlInput.value) {
                // Get current origin
                const currentOrigin = window.location.origin;
                apiUrlInput.value = currentOrigin;
            }
        });

        // Agent Installer Form Handler
        const agentInstallerForm = document.getElementById('agentInstallerForm');
        if (agentInstallerForm) {
            agentInstallerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const downloadBtn = document.getElementById('downloadInstallerBtn');
                const originalText = downloadBtn.innerHTML;
                
                // Disable button and show loading
                downloadBtn.disabled = true;
                downloadBtn.innerHTML = '<span class="spinner"></span> Generating installer...';
                
                try {
                    // Collect form data
                    const formData = {
                        apiUrl: document.getElementById('apiUrl').value.trim(),
                        enableApplicationMonitoring: document.querySelector('input[name="enableApplicationMonitoring"]').checked,
                        enableWindowFocusMonitoring: document.querySelector('input[name="enableWindowFocusMonitoring"]').checked,
                        enableBrowserMonitoring: document.querySelector('input[name="enableBrowserMonitoring"]').checked,
                        enableNetworkMonitoring: document.querySelector('input[name="enableNetworkMonitoring"]').checked,
                        checkIntervalSeconds: parseInt(document.getElementById('checkIntervalSeconds').value) || 30,
                        startWithWindows: document.getElementById('startWithWindows').value === 'true',
                        hideGui: document.querySelector('input[name="hideGui"]').checked,
                        silentInstall: document.querySelector('input[name="silentInstall"]').checked
                    };

                    // Validate
                    if (!formData.apiUrl) {
                        Toast.error('Please enter an API URL');
                        downloadBtn.disabled = false;
                        downloadBtn.innerHTML = originalText;
                        return;
                    }

                    // Make POST request to generate installer
                    const response = await fetch('/download/activity-agent-installer', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });

                    if (!response.ok) {
                        const error = await response.json().catch(() => ({ error: 'Failed to generate installer' }));
                        throw new Error(error.error || 'Failed to generate installer');
                    }

                    // Get filename from Content-Disposition header or use default
                    const contentDisposition = response.headers.get('Content-Disposition');
                    let filename = 'SasWatchAgent-Installer.zip';
                    if (contentDisposition) {
                        const match = contentDisposition.match(/filename="?(.+?)"?$/);
                        if (match) filename = match[1];
                    }

                    // Download the file
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);

                    Toast.success('‚úì Installer downloaded successfully!');
                } catch (error) {
                    console.error('Installer generation error:', error);
                    Toast.error('Failed to generate installer: ' + error.message);
                } finally {
                    downloadBtn.disabled = false;
                    downloadBtn.innerHTML = originalText;
                }
            });
        }
    </script>
        </div>
    </main>
</body>
</html>


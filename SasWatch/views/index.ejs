<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <img src="/images/logoTransp.png" alt="SasWatch" class="logo-image" width="32" height="32">
                <span>SasWatch</span>
            </div>
            <button class="sidebar-toggle" onclick="toggleSidebar()" title="Toggle sidebar">
                <span id="sidebar-toggle-icon">‚óÄ</span>
            </button>
        </div>
        
        <nav class="sidebar-nav">
            <div class="sidebar-nav-item">
                <a href="/" class="sidebar-nav-link" data-tooltip="Renewals">
                    <span class="nav-icon">üìÖ</span>
                    <span>Renewals</span>
                </a>
            </div>
            <div class="sidebar-nav-item">
                <a href="/users" class="sidebar-nav-link" data-tooltip="Users">
                    <span class="nav-icon">üë•</span>
                    <span>Users</span>
                </a>
            </div>
            <div class="sidebar-nav-item">
                <a href="/licenses" class="sidebar-nav-link" data-tooltip="Licenses">
                    <span class="nav-icon">üìú</span>
                    <span>Licenses</span>
                </a>
            </div>
            <div class="sidebar-nav-item">
                <a href="/apps" class="sidebar-nav-link" data-tooltip="Applications">
                    <span class="nav-icon">üì¶</span>
                    <span>Apps</span>
                </a>
            </div>
            <div class="sidebar-nav-item">
                <a href="/dashboard" class="sidebar-nav-link active" data-tooltip="Activity">
                    <span class="nav-icon">üìä</span>
                    <span>Activity</span>
                </a>
            </div>
            <div class="sidebar-nav-item">
                <a href="/account" class="sidebar-nav-link" data-tooltip="Account">
                    <span class="nav-icon">‚öôÔ∏è</span>
                    <span>Account</span>
                </a>
            </div>
            <div class="sidebar-nav-item">
                <a href="/members" class="sidebar-nav-link" data-tooltip="Team">
                    <span class="nav-icon">üßë‚Äçü§ù‚Äçüßë</span>
                    <span>Team</span>
                </a>
            </div>
            <% if (typeof account !== 'undefined' && account && account.isSuperAdmin) { %>
            <div class="sidebar-nav-item">
                <a href="/dev" class="sidebar-nav-link" data-tooltip="Dev Tools">
                    <span class="nav-icon">üõ†Ô∏è</span>
                    <span>Dev</span>
                </a>
            </div>
            <% } %>
            <% if (typeof account !== 'undefined' && account && account.isSuperAdmin) { %>
            <div class="sidebar-nav-item">
                <a href="/admin" class="sidebar-nav-link" data-tooltip="Platform Admin">
                    <span class="nav-icon">üëë</span>
                    <span>Platform Admin</span>
                </a>
            </div>
            <% } %>
        </nav>
        
        <div class="sidebar-footer">
            <div class="sidebar-footer-actions">
                <a href="/logout" class="sidebar-footer-link">
                    <span class="nav-icon">üö™</span>
                    <span>Logout</span>
                </a>
                <button class="sidebar-footer-link" onclick="toggleTheme()" style="border: none; background: transparent; width: 100%; text-align: left; cursor: pointer;" title="Toggle theme">
                    <span class="nav-icon" id="theme-icon">‚òÄÔ∏è</span>
                    <span>Theme</span>
                </button>
            </div>
        </div>
    </aside>

    <!-- Mobile Menu Overlay -->
    <div class="mobile-menu-overlay" id="mobile-overlay" onclick="closeMobileMenu()"></div>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Mobile Navigation -->
            <nav class="mobile-nav">
                <div class="mobile-nav-item">
                    <a href="/" class="mobile-nav-link">
                        <span>üìÖ</span>
                        <span>Renewals</span>
                    </a>
                </div>
                <div class="mobile-nav-item">
                    <a href="/users" class="mobile-nav-link">
                        <span>üë•</span>
                        <span>Users</span>
                    </a>
                </div>
                <div class="mobile-nav-item">
                    <a href="/licenses" class="mobile-nav-link">
                        <span>üìú</span>
                        <span>Licenses</span>
                    </a>
                </div>
                <div class="mobile-nav-item">
                    <a href="/apps" class="mobile-nav-link">
                        <span>üì¶</span>
                        <span>Apps</span>
                    </a>
                </div>
                <div class="mobile-nav-item">
                    <a href="/dashboard" class="mobile-nav-link active">
                        <span>üìä</span>
                        <span>Activity</span>
                    </a>
                </div>
                <div class="mobile-nav-item">
                    <a href="/account" class="mobile-nav-link">
                        <span>‚öôÔ∏è</span>
                        <span>Account</span>
                    </a>
                </div>
                <% if (typeof account !== 'undefined' && account && account.isSuperAdmin) { %>
                <div class="mobile-nav-item">
                    <a href="/dev" class="mobile-nav-link">
                        <span>üõ†Ô∏è</span>
                        <span>Dev</span>
                    </a>
                </div>
                <% } %>
            </nav>

            <header>
                <div class="header-content">
                    <h1>
                        <span class="header-icon" aria-hidden="true">üìä</span>
                        <span class="header-title-text">Activity</span>
                    </h1>
                </div>
            </header>

            <div class="stats-grid">
                <div class="stat-card adobe">
                    <div class="stat-content">
                        <div class="stat-label">Web Apps</div>
                        <div class="stat-value">
                            <span id="adobe-total"><%= adobeCount %></span>
                            <span class="stat-icon">üåê</span>
                        </div>
                        <div class="stat-detail" id="adobe-today">0 today</div>
                    </div>
                </div>

                <div class="stat-card wrapper">
                    <div class="stat-content">
                        <div class="stat-label">Desktop Apps</div>
                        <div class="stat-value">
                            <span id="wrapper-total"><%= wrapperCount %></span>
                            <span class="stat-icon">üíª</span>
                        </div>
                        <div class="stat-detail" id="wrapper-today">0 today</div>
                    </div>
                </div>

                <div class="stat-card combined">
                    <div class="stat-content">
                        <div class="stat-label">This Week</div>
                        <div class="stat-value">
                            <span id="week-total">0</span>
                            <span class="stat-icon">üìà</span>
                        </div>
                        <div class="stat-detail" id="unique-clients">0 unique clients</div>
                    </div>
                </div>
            </div>

            <div class="tab-content active">
                <div class="tab-content-header">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <h2>Recent Activity</h2>
                        <select id="source-filter" class="filter-select" onchange="filterBySource(this.value)" style="min-width: 180px;">
                            <option value="all">All Sources</option>
                            <option value="wrapper">Desktop Apps</option>
                            <option value="adobe">Web Apps</option>
                            <option value="entra">Sign-In Logs</option>
                        </select>
                    </div>
                    <div class="dashboard-controls">
                        <button class="btn btn-primary" onclick="startManualSync()">
                            üîÑ Refresh
                        </button>
                        <% if (typeof account !== 'undefined' && account && account.isSuperAdmin) { %>
                        <button
                            class="btn btn-secondary"
                            id="sync-graph-btn"
                            onclick="syncGraphManual()"
                            title="Superadmin: Force sync from Microsoft Graph API"
                            data-sync-hours="24"
                            data-sync-limit="50"
                            data-sync-page-size="25">
                            ‚òÅÔ∏è Sync Graph
                        </button>
                        <% } %>
                        <button class="btn btn-danger" onclick="clearData()">üóëÔ∏è Clear Data</button>
                    </div>
                </div>
                <div id="recent-activity" class="activity-table-container">
                    <div class="loading">Loading...</div>
                </div>
                <div class="sync-log-container">
                    <div class="sync-log-header" onclick="toggleSyncLog()">
                        <div class="sync-log-title">Sync Log</div>
                        <span class="sync-log-toggle" id="sync-log-toggle">‚ñº</span>
                    </div>
                    <div class="sync-log-content" id="sync-log-content">
                        <pre id="sync-log-output" class="sync-log-output">Ready.</pre>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Critical scripts (load immediately) -->
    <script src="/js/ui-components.js"></script>
    <!-- Socket.IO client library (CDN with fallback) -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" 
            integrity="sha384-2huaZvOR9iDzHqslqwpR87isEmrfxqyWOF7hr7BY6KG0+hVKLoEXMPUJw3ynWuhO" 
            crossorigin="anonymous"></script>
    <!-- Real-time socket client -->
    <script src="/js/socket-client.js"></script>
    <!-- Non-critical scripts (defer loading) -->
    <script src="/js/app.js" defer></script>
    <script>
        // Sidebar toggle functionality
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const icon = document.getElementById('sidebar-toggle-icon');
            
            // On mobile, toggle overlay menu instead
            if (window.innerWidth <= 768) {
                toggleMobileMenu();
                return;
            }
            
            sidebar.classList.toggle('collapsed');
            
            // Save state
            const isCollapsed = sidebar.classList.contains('collapsed');
            localStorage.setItem('sidebarCollapsed', isCollapsed);
            icon.textContent = isCollapsed ? '‚ñ∂' : '‚óÄ';
        }

        // Mobile menu functions
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-overlay');
            sidebar.classList.toggle('mobile-open');
            overlay.classList.toggle('active');
        }

        function closeMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-overlay');
            sidebar.classList.remove('mobile-open');
            overlay.classList.remove('active');
        }

        // Expose to window for onclick handlers
        window.toggleSidebar = toggleSidebar;
        window.closeMobileMenu = closeMobileMenu;

        // Handle window resize
        window.addEventListener('resize', () => {
            if (window.innerWidth > 768) {
                closeMobileMenu();
            }
        });

        // Theme toggle functionality
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            // Update icon
            const icon = document.getElementById('theme-icon');
            icon.textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize theme (default to dark)
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            const themeIcon = document.getElementById('theme-icon');
            themeIcon.textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            
            // Initialize sidebar state
            const sidebar = document.getElementById('sidebar');
            const sidebarIcon = document.getElementById('sidebar-toggle-icon');
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            
            // Show mobile menu button on mobile
            if (window.innerWidth <= 768) {
                mobileMenuBtn.style.display = 'block';
            }
            
            // Only restore collapsed state on desktop
            if (window.innerWidth > 768) {
                const savedSidebarState = localStorage.getItem('sidebarCollapsed') === 'true';
                if (savedSidebarState) {
                    sidebar.classList.add('collapsed');
                    sidebarIcon.textContent = '‚ñ∂';
                }
            }
            
            // Close mobile menu when clicking sidebar links
            const sidebarLinks = document.querySelectorAll('.sidebar-nav-link, .sidebar-footer-link');
            sidebarLinks.forEach(link => {
                link.addEventListener('click', () => {
                    if (window.innerWidth <= 768) {
                        closeMobileMenu();
                    }
                });
            });
        });
    </script>

    <%- include('_survey-widget') %>
</body>
</html>

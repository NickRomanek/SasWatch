<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <span>üìä</span>
                <span>SasWatch</span>
            </div>
            <button class="sidebar-toggle" onclick="toggleSidebar()" title="Toggle sidebar">
                <span id="sidebar-toggle-icon">‚óÄ</span>
            </button>
        </div>
        
        <nav class="sidebar-nav">
            <div class="sidebar-nav-item">
                <a href="/" class="sidebar-nav-link active" data-tooltip="Users">
                    <span class="nav-icon">üë•</span>
                    <span>Users</span>
                </a>
            </div>
            <div class="sidebar-nav-item">
                <a href="/apps" class="sidebar-nav-link" data-tooltip="Applications">
                    <span class="nav-icon">üì¶</span>
                    <span>Apps</span>
                </a>
            </div>
            <div class="sidebar-nav-item">
                <a href="/dashboard" class="sidebar-nav-link" data-tooltip="Activity">
                    <span class="nav-icon">üìä</span>
                    <span>Activity</span>
                </a>
            </div>
            <div class="sidebar-nav-item">
                <a href="/account" class="sidebar-nav-link" data-tooltip="Account">
                    <span class="nav-icon">‚öôÔ∏è</span>
                    <span>Account</span>
                </a>
            </div>
            <div class="sidebar-nav-item">
                <a href="/dev" class="sidebar-nav-link" data-tooltip="Dev Tools">
                    <span class="nav-icon">üõ†Ô∏è</span>
                    <span>Dev</span>
                </a>
            </div>
        </nav>
        
        <div class="sidebar-footer">
            <div class="sidebar-footer-actions">
                <a href="/logout" class="sidebar-footer-link">
                    <span class="nav-icon">üö™</span>
                    <span>Logout</span>
                </a>
                <button class="sidebar-footer-link" onclick="toggleTheme()" style="border: none; background: transparent; width: 100%; text-align: left; cursor: pointer;" title="Toggle theme">
                    <span class="nav-icon" id="theme-icon">‚òÄÔ∏è</span>
                    <span>Theme</span>
                </button>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <header>
                <div class="header-content">
                    <h1>üë• Users <span class="user-count-badge">(<span id="header-user-count"><%= users ? users.length : 0 %></span>)</span></h1>
                    <p class="subtitle">User Management</p>
                </div>
                <!-- Action Buttons -->
                <div class="action-buttons-container">
                    <% if (!azureSyncEnabled) { %>
                        <div class="dropdown-wrapper">
                            <button class="btn btn-primary dropdown-btn" onclick="toggleDropdown('connectors-dropdown')">
                                üîå Connectors <span class="dropdown-arrow">‚ñº</span>
                            </button>
                            <div class="dropdown-menu" id="connectors-dropdown">
                                <a href="/integrations/entra/connect" class="dropdown-item">
                                    ‚òÅÔ∏è Microsoft Entra
                                </a>
                            </div>
                        </div>
                    <% } %>
                    
                    <button class="btn btn-secondary" onclick="toggleImportSection('licenses')">
                        üìã Licenses
                    </button>
                    
                    <div class="dropdown-wrapper">
                        <button class="btn btn-secondary dropdown-btn" onclick="toggleDropdown('import-dropdown')">
                            üì• Import <span class="dropdown-arrow">‚ñº</span>
                        </button>
                        <div class="dropdown-menu" id="import-dropdown">
                            <a href="#" class="dropdown-item" onclick="event.preventDefault(); toggleImportSection('adobe'); return false;">
                                üìÅ Adobe
                            </a>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Licenses Management Section (collapsible) -->
            <div class="import-section" id="licenses-import-section" style="display: none;">
                <div class="upload-card">
                    <div class="upload-header" style="display: flex !important; flex-direction: row !important; justify-content: center !important; align-items: center !important; gap: 1rem;">
                        <h2 style="margin: 0;">üìã Manage Licenses</h2>
                        <button class="btn btn-primary" onclick="closeLicensesSection()">
                            Close
                        </button>
                    </div>
                    <div id="licenses-list" style="margin-top: 1.5rem;">
                        <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            Loading licenses...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Adobe Import Section (collapsible) -->
            <div class="import-section" id="adobe-import-section" style="display: none;">
                <div class="upload-card">
                    <div class="upload-header">
                        <div class="upload-info">
                            <h2>
                                <span style="white-space: nowrap;">üìÅ Import Adobe User List</span>
                                <% if (users && users.length > 0) { %>
                                    <div class="upload-status-inline">
                                        <span class="status-badge status-success">‚úì Imported</span>
                                        <span class="upload-count"><strong><%= users.length %></strong> users loaded</span>
                                    </div>
                                <% } %>
                            </h2>
                            <% if (!users || users.length === 0) { %>
                                <p style="margin-top: 0.25rem; font-size: 0.875rem; color: var(--text-secondary);">Upload your Adobe Admin Console user export to begin tracking license usage.</p>
                            <% } %>
                        </div>
                        <% if (users && users.length > 0) { %>
                        <div class="upload-actions">
                            <button class="btn btn-secondary" onclick="document.getElementById('csv-upload-form').style.display='block'">
                                üì§ Upload New CSV
                            </button>
                        </div>
                        <% } %>
                        
                        <% if (users && users.length > 0 && unmappedUsernames && unmappedUsernames.length > 0) { %>
                        <div class="unmapped-info-notice">
                            <span class="info-icon-small">‚ÑπÔ∏è</span>
                            <span>We detected Windows usernames sending activity that aren't linked to any imported user. Map them to ensure activity is attributed correctly.</span>
                        </div>
                        <% } %>
                    </div>
                    
                    <form id="csv-upload-form" style="<%= users && users.length > 0 ? 'display:none' : '' %>" enctype="multipart/form-data">
                        <div class="upload-dropzone" id="upload-dropzone">
                            <input type="file" id="csv-file-input" name="csvFile" accept=".csv" style="display:none">
                            <div class="upload-prompt">
                                <span class="upload-icon">üìÑ</span>
                                <p>Drag and drop CSV file here or click to browse</p>
                                <small>Expected format: Email, First Name, Last Name, Admin Roles, User Groups, Team Products</small>
                            </div>
                        </div>
                        <div id="upload-progress" style="display:none">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progress-fill"></div>
                            </div>
                            <p id="upload-status">Uploading...</p>
                        </div>
                    </form>
                </div>
            </div>

        <% if (azureSyncEnabled) { %>
        <!-- Azure Sync Section -->
        <div class="azure-sync-section">
            <div class="sync-header">
                <h2>‚òÅÔ∏è Azure Security Group Sync</h2>
                <div class="sync-status" id="sync-status">
                    <span class="status-indicator"></span>
                    <span id="connection-status" class="status-text">Checking connection...</span>
                </div>
            </div>

            <!-- Configuration -->
            <div class="sync-config-card">
                <h3>‚öôÔ∏è Configuration</h3>
                <div class="config-form">
                    <div class="form-group">
                        <label for="inactive-threshold">
                            Inactive Threshold (days):
                            <span class="label-hint">Users with no activity for this many days are considered inactive</span>
                        </label>
                        <input type="number" id="inactive-threshold" value="90" min="30" max="365" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="auto-sync-enabled">
                            <span>Enable automatic weekly sync</span>
                            <span class="label-hint">Automatically move inactive users every Sunday at midnight</span>
                        </label>
                    </div>
                    <button class="btn btn-primary" onclick="saveAzureConfig()">üíæ Save Settings</button>
                </div>
            </div>

            <!-- Group Management -->
            <div class="sync-actions">
                <div class="sync-card">
                    <div class="sync-card-header">
                        <h3>1Ô∏è‚É£ Create Active Users Group</h3>
                        <span id="active-group-status"></span>
                    </div>
                    <p class="sync-card-description">Creates security group in Azure and adds all imported users with Adobe licenses</p>
                    <input type="text" id="active-group-name" placeholder="Adobe-Active-Users" class="form-input">
                    <button class="btn btn-success" onclick="createActiveGroup()">
                        ‚ûï Create Active Group
                    </button>
                </div>
                
                <div class="sync-card">
                    <div class="sync-card-header">
                        <h3>2Ô∏è‚É£ Create Inactive Users Group</h3>
                        <span id="inactive-group-status"></span>
                    </div>
                    <p class="sync-card-description">Creates empty security group for users to be removed from monitoring</p>
                    <input type="text" id="inactive-group-name" placeholder="Adobe-Inactive-Users" class="form-input">
                    <button class="btn btn-success" onclick="createInactiveGroup()">
                        ‚ûï Create Inactive Group
                    </button>
                </div>
                
                <div class="sync-card">
                    <div class="sync-card-header">
                        <h3>3Ô∏è‚É£ Move Inactive Users</h3>
                    </div>
                    <p class="sync-card-description" id="inactive-preview">Loading preview...</p>
                    <div class="sync-card-actions">
                        <button class="btn btn-warning" onclick="previewInactive()">
                            üëÅÔ∏è Preview Inactive Users
                        </button>
                        <button class="btn btn-primary" onclick="moveInactive()">
                            ‚ÜóÔ∏è Move to Inactive Group
                        </button>
                    </div>
                </div>
            </div>

            <!-- Sync History -->
            <div class="sync-history">
                <h3>üìã Last Sync Results</h3>
                <div id="sync-results">
                    <p class="no-sync-history">No sync history yet</p>
                </div>
            </div>
        </div>
        <% } %>

        <!-- Unmapped Usernames Section -->
        <% if (unmappedUsernames && unmappedUsernames.length > 0) { %>
        <div class="unmapped-section" id="unmapped-section">
            <h2>
                üîó Map Unmapped Usernames
                <span class="status-badge status-warning" style="margin-left: 0.75rem;"><strong><%= unmappedUsernames.length %></strong> to map</span>
            </h2>
            <table class="unmapped-table">
                <thead>
                    <tr>
                        <th>Windows Username</th>
                        <th>Activity Count</th>
                        <th>First Seen</th>
                        <th>Map to User</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <% unmappedUsernames.forEach(unmapped => { %>
                    <tr data-username="<%= unmapped.username %>">
                        <td><strong><%= unmapped.username %></strong></td>
                        <td><%= unmapped.activityCount || 0 %></td>
                        <td><%= new Date(unmapped.firstSeen).toLocaleString() %></td>
                        <td>
                            <select class="user-select" data-username="<%= unmapped.username %>">
                                <option value="">Select user...</option>
                                <% users.forEach(user => { %>
                                <option value="<%= user.email %>"><%= user.firstName %> <%= user.lastName %> (<%= user.email %>)</option>
                                <% }); %>
                            </select>
                        </td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="mapUsername('<%= unmapped.username %>')">Map</button>
                        </td>
                    </tr>
                    <% }); %>
                </tbody>
            </table>
        </div>
        <% } %>

        <!-- Users Table Section -->
        <div class="users-section">
            <div class="users-header">
                <div class="users-controls">
                    <input type="text" id="search-input" placeholder="Search by name or email..." class="search-box">
                    <select id="license-filter" class="filter-select">
                        <option value="">All Licenses</option>
                        <option value="Adobe Acrobat Pro">Adobe Acrobat Pro</option>
                        <option value="Creative Cloud Pro">Creative Cloud Pro</option>
                        <option value="no-license">No License</option>
                    </select>
                    <select id="status-filter" class="filter-select">
                        <option value="">All Entra Status</option>
                        <option value="active">Enabled (Entra)</option>
                        <option value="inactive">Disabled (Entra)</option>
                        <option value="unknown">Pending Sync</option>
                    </select>
                </div>
                <% if (azureSyncEnabled || (users && users.length > 0)) { %>
                <div class="users-header-right">
                    <% if (azureSyncEnabled) { %>
                    <button class="btn btn-primary" id="entra-sync-btn" onclick="syncEntraUsers(event)">
                        üîÑ Sync
                    </button>
                    <% } %>
                    <% if (users && users.length > 0) { %>
                    <button class="btn btn-danger" id="delete-all-btn" onclick="deleteAllUsers()">
                        üóëÔ∏è Delete All
                    </button>
                    <div id="selected-actions" style="display: none; gap: 0.5rem; align-items: center;">
                        <button class="btn btn-primary" onclick="mergeSelectedUsers()">
                            üîÄ Merge Selected
                        </button>
                        <button class="btn btn-danger" onclick="deleteSelectedUsers()">
                            üóëÔ∏è Delete Selected
                        </button>
                    </div>
                    <% } %>
                </div>
                <% } %>
            </div>

            <% if (!users || users.length === 0) { %>
            <div class="empty-state">
                <div class="empty-icon">üìã</div>
                <h3>No Users Imported</h3>
                <p>Upload your Adobe Admin Console user export CSV to get started.</p>
            </div>
            <% } else { %>
            <table class="users-table" id="users-table">
                <thead>
                    <tr>
                        <th style="width: 40px;">
                            <input type="checkbox" id="select-all-checkbox" title="Select all users">
                        </th>
                        <th onclick="sortTable('name')">Name <span class="sort-icon">‚Üï</span></th>
                        <th onclick="sortTable('email')">Email <span class="sort-icon">‚Üï</span></th>
                        <th onclick="sortTable('licenses')">Licenses <span class="sort-icon">‚Üï</span></th>
                        <th onclick="sortTable('lastActivity')">Last Activity <span class="sort-icon">‚Üï</span></th>
                        <th onclick="sortTable('activityCount')">Activity Count <span class="sort-icon">‚Üï</span></th>
                        <th>Entra Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="users-table-body">
                    <!-- Will be populated by JavaScript -->
                </tbody>
            </table>
            <% } %>
        </div>
        </div>
    </main>

    <script src="/js/theme.js"></script>
    <script src="/js/ui-components.js"></script>
    <script>
        // Pass server data to JavaScript
        const usersData = <%- JSON.stringify(users || []) %>;
        const entraSyncMeta = <%- JSON.stringify(entraSync || {}) %>;
        const entraSyncEnabled = <%= azureSyncEnabled ? 'true' : 'false' %>;
        
        // Trigger a manual Microsoft 365 user sync
        async function syncEntraUsers(event) {
            const button = event?.currentTarget || event?.target;
            if (!button) {
                console.error('Sync button reference missing');
                return;
            }

            addButtonSpinner(button, button.innerHTML);

            try {
                const response = await fetch('/api/account/entra/sync?mode=users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        includeUsers: true,
                        includeSignIns: false
                    })
                });

                const payload = await response.json().catch(() => ({}));

                if (!response.ok || payload.success === false) {
                    const errorMessage = payload.error || `Request failed with status ${response.status}`;
                    console.error('User sync failed:', errorMessage);
                    Toast.error(`Failed to sync Microsoft 365 users: ${errorMessage}`);
                    return;
                }

                const usersResult = payload.users || {};
                const count = usersResult.count ?? 0;
                const synced = usersResult.synced === true;

                if (synced) {
                    Toast.success(`‚úì Microsoft 365 user sync completed (${count} ${count === 1 ? 'user' : 'users'} updated)`);
                } else {
                    const reason = usersResult.reason ? ` (${usersResult.reason})` : '';
                    Toast.info(`Microsoft 365 user sync finished with no changes${reason}`);
                }

                setTimeout(() => window.location.reload(), 1200);
            } catch (error) {
                console.error('User sync error:', error);
                Toast.error(`Failed to sync Microsoft 365 users: ${error.message}`);
            } finally {
                removeButtonSpinner(button);
            }
        }

        // Dropdown functionality
        function toggleDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            const allDropdowns = document.querySelectorAll('.dropdown-menu');
            
            // Close all other dropdowns
            allDropdowns.forEach(d => {
                if (d.id !== dropdownId) {
                    d.classList.remove('active');
                }
            });
            
            // Toggle current dropdown
            dropdown.classList.toggle('active');
        }
        
        // Toggle import sections
        function toggleImportSection(sectionName) {
            const section = document.getElementById(`${sectionName}-import-section`);
            if (section) {
                const isVisible = section.style.display !== 'none';
                section.style.display = isVisible ? 'none' : 'block';
                
                // Close dropdown after selection (only for import)
                if (sectionName !== 'licenses') {
                    const dropdown = document.getElementById('import-dropdown');
                    if (dropdown) {
                        dropdown.classList.remove('active');
                    }
                }
                
                // Load licenses when section is opened
                if (sectionName === 'licenses' && !isVisible) {
                    loadLicenses();
                }
            }
        }
        
        // Load and display licenses
        async function loadLicenses() {
            const licensesList = document.getElementById('licenses-list');
            if (!licensesList) return;
            
            licensesList.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-secondary);">Loading licenses...</div>';
            
            try {
                const response = await fetch('/api/licenses');
                const data = await response.json();
                
                if (data.success && data.licenses) {
                    if (data.licenses.length === 0) {
                        licensesList.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-secondary);">No licenses detected yet. Import users or connect Microsoft 365 to see licenses.</div>';
                        return;
                    }
                    
                    const licensesHtml = data.licenses.map(license => {
                        const badgeClass = license.hidden ? 'status-neutral' : 'status-success';
                        const buttonText = license.hidden ? 'Show' : 'Hide';
                        const buttonClass = license.hidden ? 'btn-secondary' : 'btn-danger';
                        return `
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1rem; border-bottom: 1px solid var(--border-color);">
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <span class="status-badge ${badgeClass}">${license.hidden ? 'üëÅÔ∏è‚Äçüó®Ô∏è Hidden' : '‚úì Visible'}</span>
                                    <span style="font-weight: 500; color: var(--text-primary);">${license.name}</span>
                                </div>
                                <button class="btn ${buttonClass} btn-xs license-toggle-btn" data-license="${license.name.replace(/"/g, '&quot;')}" data-hidden="${license.hidden}">
                                    ${buttonText}
                                </button>
                            </div>
                        `;
                    }).join('');
                    
                    licensesList.innerHTML = `
                        <div style="background: var(--bg-secondary); border-radius: 8px; overflow: hidden; border: 1px solid var(--border-color);">
                            ${licensesHtml}
                        </div>
                    `;
                    
                    // Attach event listeners to buttons
                    licensesList.querySelectorAll('.license-toggle-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const licenseName = this.getAttribute('data-license');
                            const isHidden = this.getAttribute('data-hidden') === 'true';
                            toggleLicenseVisibility(licenseName, isHidden);
                        });
                    });
                } else {
                    licensesList.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--danger);">Failed to load licenses.</div>';
                }
            } catch (error) {
                console.error('Error loading licenses:', error);
                licensesList.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--danger);">Error loading licenses.</div>';
            }
        }
        
        // Toggle license visibility (make it globally accessible)
        window.toggleLicenseVisibility = async function(licenseName, currentlyHidden) {
            console.log('Toggling license:', licenseName, 'currentlyHidden:', currentlyHidden);
            try {
                const endpoint = currentlyHidden ? '/api/licenses/show' : '/api/licenses/hide';
                console.log('Calling endpoint:', endpoint);
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ license: licenseName })
                });
                
                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);
                
                if (data.success) {
                    if (typeof Toast !== 'undefined') {
                        Toast.success(`License ${currentlyHidden ? 'shown' : 'hidden'} successfully`);
                    } else {
                        alert(`License ${currentlyHidden ? 'shown' : 'hidden'} successfully`);
                    }
                    // Reload licenses list to update the UI
                    loadLicenses();
                } else {
                    throw new Error(data.error || 'Failed to update license');
                }
            } catch (error) {
                console.error('Error toggling license:', error);
                if (typeof Toast !== 'undefined') {
                    Toast.error('Failed to update license: ' + error.message);
                } else {
                    alert('Failed to update license: ' + error.message);
                }
            }
        };
        
        // Close licenses section and reload page to show changes
        window.closeLicensesSection = function() {
            const section = document.getElementById('licenses-import-section');
            if (section) {
                section.style.display = 'none';
            }
            // Reload page to show updated license visibility in user list
            window.location.reload();
        };
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.dropdown-wrapper')) {
                document.querySelectorAll('.dropdown-menu').forEach(dropdown => {
                    dropdown.classList.remove('active');
                });
            }
        });
        
        // Check for success message from URL
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('success') === 'entra_connected') {
            if (typeof Toast !== 'undefined') {
                Toast.success('Microsoft 365 connected successfully! User sync will begin automatically.');
            }
            // Clean up URL
            window.history.replaceState({}, document.title, window.location.pathname);
        }
    </script>
    <script src="/js/users.js"></script>
    <% if (azureSyncEnabled) { %>
    <script src="/js/azure-sync.js"></script>
    <% } %>
</body>
</html>


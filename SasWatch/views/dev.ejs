<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <img src="/images/logoTransp.png" alt="SasWatch" class="logo-image">
                <span>SasWatch</span>
            </div>
            <button class="sidebar-toggle" onclick="toggleSidebar()" title="Toggle sidebar">
                <span id="sidebar-toggle-icon">‚óÄ</span>
            </button>
        </div>
        
        <nav class="sidebar-nav">
            <div class="sidebar-nav-item">
                <a href="/" class="sidebar-nav-link" data-tooltip="Users">
                    <span class="nav-icon">üë•</span>
                    <span>Users</span>
                </a>
            </div>
            <div class="sidebar-nav-item">
                <a href="/apps" class="sidebar-nav-link" data-tooltip="Applications">
                    <span class="nav-icon">üì¶</span>
                    <span>Apps</span>
                </a>
            </div>
            <div class="sidebar-nav-item">
                <a href="/dashboard" class="sidebar-nav-link" data-tooltip="Activity">
                    <span class="nav-icon">üìä</span>
                    <span>Activity</span>
                </a>
            </div>
            <div class="sidebar-nav-item">
                <a href="/account" class="sidebar-nav-link" data-tooltip="Account">
                    <span class="nav-icon">‚öôÔ∏è</span>
                    <span>Account</span>
                </a>
            </div>
            <% if (typeof account !== 'undefined' && account && account.isSuperAdmin) { %>
            <div class="sidebar-nav-item">
                <a href="/dev" class="sidebar-nav-link active" data-tooltip="Dev Tools">
                    <span class="nav-icon">üõ†Ô∏è</span>
                    <span>Dev</span>
                </a>
            </div>
            <% } %>
            <% if (typeof account !== 'undefined' && account && account.isSuperAdmin) { %>
            <div class="sidebar-nav-item">
                <a href="/admin" class="sidebar-nav-link" data-tooltip="Admin">
                    <span class="nav-icon">üëë</span>
                    <span>Admin</span>
                </a>
            </div>
            <% } %>
        </nav>
        
        <div class="sidebar-footer">
            <div class="sidebar-footer-actions">
                <a href="/logout" class="sidebar-footer-link">
                    <span class="nav-icon">üö™</span>
                    <span>Logout</span>
                </a>
                <button class="sidebar-footer-link" onclick="toggleTheme()" style="border: none; background: transparent; width: 100%; text-align: left; cursor: pointer;" title="Toggle theme">
                    <span class="nav-icon" id="theme-icon">‚òÄÔ∏è</span>
                    <span>Theme</span>
                </button>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Mobile Navigation -->
            <nav class="mobile-nav">
                <div class="mobile-nav-item">
                    <a href="/" class="mobile-nav-link">
                        <span>üë•</span>
                        <span>Users</span>
                    </a>
                </div>
                <div class="mobile-nav-item">
                    <a href="/apps" class="mobile-nav-link">
                        <span>üì¶</span>
                        <span>Apps</span>
                    </a>
                </div>
                <div class="mobile-nav-item">
                    <a href="/dashboard" class="mobile-nav-link">
                        <span>üìä</span>
                        <span>Activity</span>
                    </a>
                </div>
                <div class="mobile-nav-item">
                    <a href="/account" class="mobile-nav-link">
                        <span>‚öôÔ∏è</span>
                        <span>Account</span>
                    </a>
                </div>
                <% if (typeof account !== 'undefined' && account && account.isSuperAdmin) { %>
                <div class="mobile-nav-item">
                    <a href="/dev" class="mobile-nav-link active">
                        <span>üõ†Ô∏è</span>
                        <span>Dev</span>
                    </a>
                </div>
                <% } %>
            </nav>

            <header>
                <div class="header-content">
                    <h1>
                        <span class="header-icon" aria-hidden="true">üõ†Ô∏è</span>
                        <span class="header-title-text">Dev Diagnostics</span>
                    </h1>
                    <p class="subtitle">Quick Graph API checks and raw payload previews</p>
                </div>
            </header>

            <% if (!graphConfigured) { %>
                <div class="alert-card alert-warning">
                    <h3>Graph API credentials not configured</h3>
                    <p>Set the Graph client ID and secret in your environment to enable diagnostics.</p>
                </div>
            <% } else if (!tenantConfigured) { %>
                <div class="alert-card alert-info">
                    <h3>No Microsoft 365 tenant connected</h3>
                    <p>Connect your Microsoft 365 (Entra ID) directory from the Account page to test Graph calls.</p>
                </div>
            <% } else { %>
                <section class="dev-diagnostics">
                    <div class="dev-tabs">
                        <button class="dev-tab active" data-tab="users" onclick="setDevTab('users')">Users</button>
                        <button class="dev-tab" data-tab="apps" onclick="setDevTab('apps')">Apps</button>
                        <button class="dev-tab" data-tab="activity" onclick="setDevTab('activity')">Activity</button>
                    </div>

                    <div class="dev-controls">
                        <div class="dev-input-group">
                            <label for="dev-limit">Limit</label>
                            <input id="dev-limit" type="number" min="1" max="50" value="10">
                        </div>
                        <div class="dev-input-group" id="dev-hours-group">
                            <label for="dev-hours">Lookback (hours)</label>
                            <input id="dev-hours" type="number" min="1" max="168" value="24">
                        </div>
                        <label class="dev-checkbox">
                            <input type="checkbox" id="dev-force-toggle">
                            <span>Force sync before fetch</span>
                        </label>
                        <button class="btn btn-primary" id="dev-fetch-btn" onclick="runDevFetch(event)">
                            üîÑ Sync
                        </button>
                        <button class="btn btn-secondary" onclick="populateTestData()">
                            üß™ Add Test Data
                        </button>
                        <button class="btn btn-warning" onclick="simulateStuckSync()">
                            üêõ Stuck Sync Test
                        </button>
                        <button class="btn btn-danger" onclick="clearAllData()">
                            üóëÔ∏è Clear All Data
                        </button>
                    </div>

                    <div class="dev-output">
                        <div class="dev-meta" id="dev-meta">
                            <p>Select a tab and click ‚ÄúSync‚Äù to view the command and raw response.</p>
                        </div>
                        <div class="dev-command" id="dev-command"></div>
                        <div class="dev-json" id="dev-json"></div>
                    </div>
                </section>
            <% } %>
        </div>
    </main>

    <script src="/js/ui-components.js"></script>
    <script>
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const icon = document.getElementById('sidebar-toggle-icon');
            sidebar.classList.toggle('collapsed');
            const isCollapsed = sidebar.classList.contains('collapsed');
            localStorage.setItem('sidebarCollapsed', isCollapsed);
            icon.textContent = isCollapsed ? '‚ñ∂' : '‚óÄ';
        }

        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            const icon = document.getElementById('theme-icon');
            if (icon) {
                icon.textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            const themeIcon = document.getElementById('theme-icon');
            if (themeIcon) {
                themeIcon.textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            }
            // Initialize sidebar state
            const sidebar = document.getElementById('sidebar');
            const sidebarIcon = document.getElementById('sidebar-toggle-icon');
            const savedSidebarState = localStorage.getItem('sidebarCollapsed') === 'true';
            if (savedSidebarState) {
                sidebar.classList.add('collapsed');
                sidebarIcon.textContent = '‚ñ∂';
            }

            // Default tab state
            setDevTab('users');
        });

        const devConfig = {
            users: {
                url: '/api/dev/graph/users',
                description: 'Fetches Microsoft 365 users via Graph.'
            },
            apps: {
                url: '/api/apps/sync',
                description: 'Runs the Applications sync (same as the Apps page) and returns the combined dataset.'
            },
            activity: {
                url: '/api/dev/graph/activity',
                description: 'Retrieves recent sign-in events from Entra audit logs.'
            }
        };

        let activeDevTab = 'users';

        function setDevTab(tab) {
            activeDevTab = tab;
            document.querySelectorAll('.dev-tab').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tab);
            });
            const hoursGroup = document.getElementById('dev-hours-group');
            if (hoursGroup) {
                hoursGroup.style.display = (tab === 'activity' || tab === 'apps') ? 'flex' : 'none';
            }
            const meta = document.getElementById('dev-meta');
            if (meta && devConfig[tab]) {
                meta.innerHTML = `<p><strong>${tab.toUpperCase()}:</strong> ${devConfig[tab].description}</p>`;
            }
        }

        async function runDevFetch(event) {
            const button = event?.currentTarget || event?.target;

            if (!devConfig[activeDevTab]) {
                Toast.error('Unknown tab selected.');
                return;
            }

            const limitInput = document.getElementById('dev-limit');
            const hoursInput = document.getElementById('dev-hours');
            const forceToggle = document.getElementById('dev-force-toggle');
            const commandBlock = document.getElementById('dev-command');
            const jsonBlock = document.getElementById('dev-json');
            const metaBlock = document.getElementById('dev-meta');

            if (metaBlock) {
                metaBlock.innerHTML = '<p><strong>Status:</strong> Sync in progress‚Ä¶</p>';
            }

            const previousLabel = button ? button.innerHTML : null;
            if (button) {
                button.disabled = true;
                button.innerHTML = '‚è≥ Syncing‚Ä¶';
            }

            let requestConfig;
            if (activeDevTab === 'apps') {
                const backfillHours = Math.max(1, Math.min(168, parseInt(hoursInput?.value || '24', 10)));
                const requestBody = { backfillHours };

                if (forceToggle?.checked) {
                    requestBody.force = true;
                }

                requestConfig = {
                    url: '/api/apps/sync',
                    options: {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestBody),
                        credentials: 'same-origin'
                    },
                    command: 'POST /api/apps/sync',
                    paramsForDisplay: requestBody
                };
            } else {
                const params = new URLSearchParams();
                const limit = Math.max(1, Math.min(50, parseInt(limitInput?.value || '10', 10)));
                params.set('limit', limit);

                if (activeDevTab === 'activity' && hoursInput) {
                    const hours = Math.max(1, Math.min(168, parseInt(hoursInput.value || '24', 10)));
                    params.set('hours', hours);
                }

                if (forceToggle?.checked) {
                    params.set('force', 'true');
                }

                const queryString = params.toString();
                requestConfig = {
                    url: `${devConfig[activeDevTab].url}?${queryString}`,
                    options: { method: 'GET', credentials: 'same-origin' },
                    command: `GET ${devConfig[activeDevTab].url}?${queryString}`,
                    paramsForDisplay: Object.fromEntries(params.entries())
                };
            }

            try {
                const response = await fetch(requestConfig.url, requestConfig.options);
                const contentType = response.headers.get('content-type') || '';
                const payload = contentType.includes('application/json')
                    ? await response.json().catch(() => ({}))
                    : {};

                if (!response.ok || payload.success === false) {
                    const errMsg = payload.error || `Request failed with status ${response.status}`;
                    Toast.error(errMsg);
                    if (metaBlock) {
                        metaBlock.innerHTML = `<p class="text-error">${escapeHtml(errMsg)}</p>`;
                    }
                    if (button && previousLabel !== null) {
                        button.disabled = false;
                        button.innerHTML = previousLabel;
                    }
                    return;
                }

                const commandText = payload.command || requestConfig.command || 'N/A';
                const paramsForDisplay = payload.params || requestConfig.paramsForDisplay || {};

                if (commandBlock) {
                    commandBlock.innerHTML = `
                        <h3>Command</h3>
                        <pre>${escapeHtml(commandText)}</pre>
                        <h4>Parameters</h4>
                        <pre>${escapeHtml(JSON.stringify(paramsForDisplay, null, 2))}</pre>
                    `;
                }

                if (activeDevTab === 'apps') {
                    const syncInfo = payload.sync || {};
                    const syncReason = syncInfo.reason ? ` (${escapeHtml(syncInfo.reason)})` : '';
                    const lastSync = syncInfo.lastSync ? new Date(syncInfo.lastSync).toLocaleString() : 'N/A';

                    if (metaBlock) {
                        metaBlock.innerHTML = `
                            <p><strong>Triggered:</strong> ${new Date().toLocaleString()}</p>
                            <p><strong>Last Sync:</strong> ${lastSync}</p>
                            <p><strong>Synced:</strong> ${syncInfo.synced ? 'Yes' : 'No'}${syncReason}</p>
                            <p><strong>Processed Sign-ins:</strong> ${syncInfo.count ?? 0}</p>
                            <p><strong>Applications Returned:</strong> ${payload.apps?.length ?? 0}</p>
                        `;
                    }

                    if (jsonBlock) {
                        jsonBlock.innerHTML = `
                            <h3>Applications</h3>
                            <pre>${escapeHtml(JSON.stringify(payload.apps || [], null, 2))}</pre>
                            ${payload.stats ? `<h3>Stats</h3><pre>${escapeHtml(JSON.stringify(payload.stats, null, 2))}</pre>` : ''}
                            ${payload.sync ? `<h3>Sync Metadata</h3><pre>${escapeHtml(JSON.stringify(payload.sync, null, 2))}</pre>` : ''}
                        `;
                    }

                    Toast.success('‚úì Application sync complete');
                } else {
                    if (metaBlock) {
                        metaBlock.innerHTML = `
                            <p><strong>Requested:</strong> ${new Date(payload.requestedAt || Date.now()).toLocaleString()}</p>
                            <p><strong>Duration:</strong> ${payload.durationMs ?? 0} ms</p>
                            <p><strong>Items Returned:</strong> ${payload.meta?.totalReturned ?? (payload.data?.length || 0)}</p>
                        `;
                    }

                    if (jsonBlock) {
                        jsonBlock.innerHTML = `
                            <h3>Data</h3>
                            <pre>${escapeHtml(JSON.stringify(payload.data || [], null, 2))}</pre>
                            ${payload.meta ? `<h3>Metadata</h3><pre>${escapeHtml(JSON.stringify(payload.meta, null, 2))}</pre>` : ''}
                        `;
                    }

                    Toast.success('‚úì Graph data fetched successfully');
                }
            } catch (error) {
                console.error('Dev fetch error:', error);
                Toast.error('Failed to fetch diagnostic data: ' + error.message);
                if (metaBlock) {
                    metaBlock.innerHTML = `<p class="text-error">${escapeHtml(error.message)}</p>`;
                }
            } finally {
                if (button && previousLabel !== null) {
                    button.disabled = false;
                    button.innerHTML = previousLabel;
                }
            }
        }

        async function simulateStuckSync() {
            const button = event?.currentTarget || document.querySelector('button[onclick*="simulateStuckSync"]');
            const previousLabel = button ? button.innerHTML : null;

            if (button) {
                button.disabled = true;
                button.innerHTML = '‚è≥ Simulating‚Ä¶';
            }

            try {
                const response = await fetch('/api/test/stuck-sync', { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    Toast.success(result.message);
                } else {
                    Toast.error(result.error || 'Failed to simulate stuck sync');
                }
            } catch (error) {
                console.error('Stuck sync test error:', error);
                Toast.error('Failed to simulate stuck sync: ' + error.message);
            } finally {
                if (button && previousLabel !== null) {
                    button.disabled = false;
                    button.innerHTML = previousLabel;
                }
            }
        }

        async function populateTestData() {
            const button = event?.currentTarget || document.querySelector('button[onclick*="populateTestData"]');
            const previousLabel = button ? button.innerHTML : null;

            if (button) {
                button.disabled = true;
                button.innerHTML = '‚è≥ Adding‚Ä¶';
            }

            try {
                console.log('[TEST] Sending request to /api/test/populate-data (auth temporarily disabled for testing)');
                const response = await fetch('/api/test/populate-data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ hoursBack: 2, eventCount: 15 })
                });

                console.log('[TEST] Response status:', response.status);
                console.log('[TEST] Response headers:', Object.fromEntries(response.headers.entries()));

                if (!response.ok) {
                    const textResponse = await response.text();
                    console.error('[TEST] Error response:', textResponse.substring(0, 500));
                    throw new Error(`HTTP ${response.status}: ${textResponse.substring(0, 100)}`);
                }

                const result = await response.json();
                console.log('[TEST] Success response:', result);

                if (result.success) {
                    Toast.success(result.message);
                    // Refresh the page data to show the new test data
                    setTimeout(() => location.reload(), 1000);
                } else {
                    Toast.error(result.error || 'Failed to add test data');
                }
            } catch (error) {
                console.error('Test data error:', error);
                Toast.error('Failed to add test data: ' + error.message);
            } finally {
                if (button && previousLabel !== null) {
                    button.disabled = false;
                    button.innerHTML = previousLabel;
                }
            }
        }

        async function clearAllData() {
            if (!confirm('This will permanently delete ALL activity data and reset sync cursors. Continue?')) {
                return;
            }

            const button = event?.currentTarget || document.querySelector('button[onclick*="clearAllData"]');
            const previousLabel = button ? button.innerHTML : null;

            if (button) {
                button.disabled = true;
                button.innerHTML = '‚è≥ Clearing‚Ä¶';
            }

            try {
                const response = await fetch('/api/usage?resetCursor=true&cursorHours=24', {
                    method: 'DELETE'
                });

                if (response.ok) {
                    Toast.success('All data cleared and cursor reset');
                    // Refresh the page to show empty state
                    setTimeout(() => location.reload(), 1000);
                } else {
                    Toast.error('Failed to clear data');
                }
            } catch (error) {
                console.error('Clear data error:', error);
                Toast.error('Failed to clear data: ' + error.message);
            } finally {
                if (button && previousLabel !== null) {
                    button.disabled = false;
                    button.innerHTML = previousLabel;
                }
            }
        }

        function escapeHtml(value) {
            if (value === null || value === undefined) {
                return '';
            }
            return value
                .toString()
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        // Expose functions to window for onclick handlers
        window.setDevTab = setDevTab;
        window.runDevFetch = runDevFetch;
        window.populateTestData = populateTestData;
        window.clearAllData = clearAllData;
        window.simulateStuckSync = simulateStuckSync;
    </script>
</body>
</html>

